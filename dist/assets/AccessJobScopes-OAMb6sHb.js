import{u as ie,a as ne,b as ce,d as le,f as de,al as ue,r as t,q as _,w as C,h as f,am as me,an as ge,k as e,A as xe,m as I,l as z,ap as fe,H as he,v as V,aq as pe,ar as be,N as p}from"./index-AlbxRJrk.js";import{u as ye}from"./useAccessManager-rkPHho6Y.js";import{S as je,a as ve}from"./ScopeList-BVpSby1C.js";import{F as Se}from"./FunnelIcon-C_Cz-zVd.js";import"./TrashIcon-DqVoRP7K.js";import"./UserGroupIcon-Q_vkDVVC.js";const h=me(),Ne={ar:{pageTitle:"نظام تفويض الوصول (نطاق الوظائف)",pageDesc:"تحديد النطاقات (الشركات/الإدارات) التي يمكن لهذه الوظيفة رؤيتها والوصول إليها.",selectJobTitle:"اختر الوظيفة المانحة",searchPlaceholder:"ابحث عن وظيفة...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ التغييرات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث نطاق الوصول للوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ قواعد النطاق؟",changeJob:"تغيير الوظيفة",loadingData:"جاري تحميل بيانات الهيكل التنظيمي...",currentRules:"قواعد النطاق الحالية",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل القواعد من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Access Delegation (Job Scopes)",pageDesc:"Define which scopes (Companies/Departments) this job can see and access.",selectJobTitle:"Select Granting Job",searchPlaceholder:"Search job...",noJobsFound:"No jobs found.",save:"Save Changes",saving:"Saving...",successTitle:"Success",successMessage:"Job access scope updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save scope rules?",changeJob:"Change Job",loadingData:"Loading organizational structure...",currentRules:"Current Scope Rules",conflictTitle:"External Update",conflictMessage:"Scope rules updated externally. Load new data (lose changes)?",loadNew:"Load New",ignore:"Ignore"}},we=({job:g,onClick:s,language:v})=>e.jsx(I.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors border border-gray-600",children:e.jsx(V,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:v==="ar"?g.name_ar:g.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",g.id]})]})]})});function Ae(){const{language:g}=ie(),s=Ne[g],{canManageScope:v}=ne(),{updateJobAccessScope:E}=ye(),{showDialog:x}=ce(),{showActionLoading:H,hideActionLoading:U}=le(),{setIsDirty:b}=de(),[Je,A]=ue(),[N,B]=t.useState([]),[w,G]=t.useState([]),[M,Q]=t.useState([]),[P,W]=t.useState([]),[J,K]=t.useState([]),[X,R]=t.useState([]),[Y,T]=t.useState([]),[d,F]=t.useState(null),[L,Z]=t.useState(null),[D,ee]=t.useState(""),[y,O]=t.useState([]),[j,S]=t.useState([]),[se,$]=t.useState(!0);t.useEffect(()=>{(async()=>{$(!0);try{const[i,u,n,r,c]=await Promise.all([p(f(h,"jobs")),p(_(f(h,"companies"),C("is_allowed","==",!0))),p(f(h,"sectors")),p(f(h,"departments")),p(f(h,"sections"))]),l=i.docs.map(o=>({id:o.id,...o.data()}));B(l.filter(o=>v("control",{jobId:o.id}))),G(u.docs.map(o=>({id:o.id,...o.data()}))),Q(n.docs.map(o=>({id:o.id,...o.data()}))),W(r.docs.map(o=>({id:o.id,...o.data()}))),K(c.docs.map(o=>({id:o.id,...o.data()})))}catch(i){console.error("Error fetching structure data:",i),x({title:s.errorTitle,message:"فشل تحميل بيانات الهيكل التنظيمي",variant:"error"})}finally{$(!1)}})()},[v,s.errorTitle,x]),t.useEffect(()=>{if(!d){R([]),T([]);return}(async()=>{try{const i=_(f(h,"job_distribution"),C("job_id","==",String(d))),u=await p(i),n=new Set,r=new Set;if(u.forEach(c=>{const l=c.data();l.company_id&&n.add(l.company_id),l.section_id&&r.add(l.section_id)}),n.size>0){const c=w.filter(l=>n.has(l.id));R(c)}else R([]);if(r.size>0){const c=J.filter(l=>r.has(l.id));T(c)}else T([])}catch(i){console.error("Error fetching job distribution:",i)}})()},[d,w,J]);const m=t.useMemo(()=>JSON.stringify(j)!==JSON.stringify(y),[j,y]);t.useEffect(()=>b(m),[m,b]);const k=t.useRef(m);t.useEffect(()=>{k.current=m},[m]),t.useEffect(()=>{if(!d)return;const a=_(f(h,"access_job_scopes"),C("job_id","==",d)),i=ge(a,u=>{if(u.metadata.hasPendingWrites)return;const n=u.docs.map(r=>({docId:r.id,...r.data()}));if(k.current){const r=JSON.stringify(n),c=JSON.stringify(y);r!==c&&x({variant:"alert",title:s.conflictTitle,message:s.conflictMessage,confirmText:s.loadNew,cancelText:s.ignore,onConfirm:()=>{O(n),S(n)}})}else O(n),S(n),b(!1)});return()=>i()},[d,b,s,y,x]);const ae=a=>{F(a.id),Z(a),A({jobId:a.id})},te=a=>{S(i=>[...i,{...a,isNew:!0}])},re=a=>{S(i=>i.filter((u,n)=>n!==a))},oe=async()=>{if(!(!d||!m)){H(s.saving);try{const a=y.filter(r=>!j.some(c=>c.docId===r.docId)),i=j.filter(r=>!r.docId),u=a.map(r=>E(d,{},"remove",r.docId)),n=i.map(r=>{const{isNew:c,docId:l,...o}=r;return E(d,o,"add")});await Promise.all([...u,...n]),x({variant:"success",title:s.successTitle,message:s.successMessage})}catch(a){x({variant:"alert",title:s.errorTitle,message:a.message||s.errorMessage})}finally{U()}}},q=N.filter(a=>a.name_ar?.includes(D)||a.name_en?.includes(D));return se?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(xe,{mode:"wait",children:d?e.jsxs(I.div,{variants:z,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]",children:e.jsx(V,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:g==="ar"?L?.name_ar:L?.name_en}),e.jsx("p",{className:"text-xs text-blue-400 font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{F(null),b(!1),A({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"})," ",s.changeJob]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsx(je,{jobs:N,companies:X,sectors:M,departments:P,sections:Y,onAddRule:te,t:s}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(ve,{rules:j,onRemove:re,jobs:N,companies:w,sectors:M,departments:P,sections:J,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!m,onClick:()=>x({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:oe}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${m?"bg-blue-500 text-white hover:scale-105 hover:bg-blue-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(be,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(I.div,{variants:z,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-blue-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:D,onChange:a=>ee(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(he,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),q.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:q.map(a=>e.jsx(we,{job:a,language:g,onClick:()=>ae(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noJobsFound})})]})},"select")})})}export{Ae as default};
