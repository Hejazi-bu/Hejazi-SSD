import{u as xe,a as Ee,b as Me,c as Ce,d as _e,e as Fe,f as De,r as n,g as se,q as he,w as Te,h as ne,i as re,o as Ae,j as X,k as e,A as ce,m,l as Re,F as de,n as L,p as Ie,s as Ve,t as ke,v as Le,x as ie,y as $e,z as oe,B as ve,C as Ge,D as Oe,E as Qe,G as fe}from"./index-DjQnKye2.js";import{F as He}from"./CalendarIcon-COYbbu5Y.js";const ue=()=>({toFirestore:a=>a,fromFirestore:(a,r)=>({id:a.id,...a.data(r)})}),Pe=ue(),Ye=ue(),Be=ue(),me=(a,r)=>{const u={useGrouping:!1,...r};try{return new Intl.NumberFormat("en-US",u).format(Number(a))}catch{return String(a)}};function Ue({rating:a,onChange:r,language:u}){const d={ar:["","تحتاج إلى تحسين","مقبول","جيد","جيد جدا","ممتاز"],en:["","Need improvement","Acceptable","Good","Very Good","Excellent"]},c=n.useMemo(()=>u==="ar"?[1,2,3,4,5].reverse():[1,2,3,4,5],[u]);return e.jsx("div",{className:"flex items-center gap-1 relative select-none",dir:"ltr",children:c.map(h=>e.jsx(m.div,{className:"relative cursor-pointer",onClick:()=>r(h),title:d[u][h],variants:L,whileHover:"hover",whileTap:"tap",children:e.jsx(fe,{className:`w-8 h-8 transition-colors duration-200 ${h<=a?"text-yellow-400":"text-gray-500 hover:text-gray-400"}`})},h))})}function ze({rating:a,language:r}){const u=n.useMemo(()=>r==="ar"?[1,2,3,4,5].reverse():[1,2,3,4,5],[r]),d=e.jsx(e.Fragment,{children:u.map(h=>e.jsx(fe,{className:`w-8 h-8 ${h<=Math.round(a)?"text-yellow-400":"text-gray-500"}`},h))}),c=e.jsxs("span",{className:"text-xl font-semibold text-white",children:[me(a*20,{maximumFractionDigits:0}),"%"]});return e.jsx("div",{className:"flex items-center gap-2 justify-center mb-4 select-none",dir:"ltr",children:r==="ar"?e.jsxs(e.Fragment,{children:[c,d]}):e.jsxs(e.Fragment,{children:[d,c]})})}function qe(a,r){const u=Math.round(a);return{ar:["","تحتاج إلى تحسين","مقبول","جيد","جيد جداً","ممتاز"],en:["","Need improvement","Acceptable","Good","Very Good","Excellent"]}[r][u]||""}function le({Icon:a,label:r,subLabel:u,value:d,color:c,disableFormatting:h=!1,actionButton:$}){return e.jsxs(m.div,{variants:L,whileHover:"hover",className:"group relative flex items-center gap-3 bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 shadow-md border border-gray-700 hover:border-[#FFD700]/30 transition-colors duration-300",children:[e.jsx(a,{className:`w-6 h-6 ${c}`}),e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"text-gray-400 font-semibold text-sm",children:r}),u&&e.jsx("span",{className:"text-gray-500 text-xs mt-0.5",children:u}),e.jsx("span",{className:"block font-bold text-xl text-white",dir:"ltr",children:h?d:me(d||0)})]}),$&&e.jsx("div",{className:"absolute top-2 right-2 rtl:right-auto rtl:left-2",children:$})]})}function Je({companiesForEval:a,selectedCompany:r,onCompanyChange:u,questions:d,onQuestionChange:c,summary:h,onSummaryChange:$,onSubmit:Z,isSubmitting:z,targetYear:N,targetMonth:v,translations:_,questionsRefs:G,showDialog:y,canPerformSaveAction:S,userHasSignature:A}){const{language:i}=xe(),x={..._[i],..._[i].common},H=n.useMemo(()=>d.length>0?d.reduce((o,g)=>o+g.ratingValue,0)/d.length:0,[d]),q=n.useMemo(()=>{if(N===null||v===null)return"";const g=new Date(N,v-1).toLocaleString(i==="ar"?"ar-EG":"en-US",{month:"long"}),E=me(N);return i==="ar"?`${g} ${E}`:`${g} ${E}`},[N,v,i]),O=n.useMemo(()=>v===null||N===null?"":new Date(N,v-1).toLocaleString(i==="ar"?"ar-EG":"en-US",{month:"long"}),[v,N,i]),ee={initial:{opacity:0,y:20},animate:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}},exit:{opacity:0,y:-20,transition:{duration:.3,ease:"easeIn"}}},Q=e.jsx(m.button,{className:"focus:outline-none",variants:L,whileHover:{scale:1.1,y:-1},whileTap:"tap",onClick:()=>y({variant:"alert",title:i==="ar"?"للعلم":"Information",message:i==="ar"?"هذه الميزة قيد البرمجة حالياً.":"This feature is currently under development."}),children:e.jsx(Ie,{className:"w-5 h-5 text-gray-500 hover:text-white transition-colors"})});return e.jsx(m.div,{variants:Ve,initial:"initial",animate:"animate",exit:"exit",className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl space-y-6 p-4 sm:p-6 border border-gray-700",children:a.length>0&&r?e.jsxs(e.Fragment,{children:[e.jsx(ce,{mode:"wait",children:e.jsxs(m.div,{variants:ee,initial:"initial",animate:"animate",exit:"exit",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch",children:[e.jsxs(m.div,{className:"bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 shadow-md border border-gray-700 hover:border-[#FFD700]/30 transition-colors duration-300 flex flex-col justify-center",variants:L,whileHover:"hover",children:[e.jsx("label",{className:"block mb-1 font-semibold text-gray-300 text-sm",children:x.company}),e.jsx("select",{value:r.id,onChange:o=>u(a.find(g=>g.id===o.target.value)||null),className:"w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700]",children:a.map(o=>e.jsx("option",{value:o.id,children:i==="ar"?o.name_ar:o.name_en||o.name_ar},o.id))})]}),e.jsxs(m.div,{className:"flex items-center gap-3 bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 shadow-md border border-gray-700 hover:border-[#FFD700]/30 transition-colors duration-300",variants:L,whileHover:"hover",children:[e.jsx(He,{className:"w-6 h-6 text-[#FFD700]"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400 font-semibold text-sm",children:x.month}),e.jsx("div",{className:"text-white font-bold text-xl",dir:i==="ar"?"rtl":"ltr",children:q})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mt-6",children:[e.jsx(le,{Icon:ke,label:x.guardCount,value:r.guard_count,color:"text-blue-400",actionButton:Q}),e.jsx(le,{Icon:de,label:x.violationsCount,subLabel:i==="ar"?`لشهر ${O}`:`for ${O}`,value:r.violations_count,color:"text-red-400",actionButton:Q}),e.jsx(le,{Icon:Le,label:x.contractNo,value:r.contract_no,color:"text-green-400",disableFormatting:!0})]})]},r.id)}),e.jsx(m.div,{variants:ie,className:"space-y-6 pt-4 border-t border-gray-700",children:d.map((o,g)=>e.jsxs(m.div,{ref:E=>G.current[g]=E,className:`p-4 bg-gray-900/50 rounded-lg shadow-md border ${o.invalid?"border-red-500":"border-gray-700"}`,variants:{...L,...$e},whileHover:"hover",animate:o.shake?"animate":"initial",children:[e.jsx("p",{className:"mb-3 font-semibold text-gray-200",children:o.text}),e.jsxs("div",{dir:i==="ar"?"rtl":"ltr",className:"flex flex-col md:flex-row gap-4 w-full",children:[e.jsx("div",{className:"flex items-center",children:e.jsx(Ue,{rating:o.ratingValue,onChange:E=>c(g,"ratingValue",E),language:i})}),e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{placeholder:i==="ar"?"ملاحظات (اختياري)...":"Notes (optional)...",value:o.note,onChange:E=>c(g,"note",E.target.value),className:"w-full bg-gray-700 border border-gray-600 rounded-md p-2 resize-y",rows:1})})]})]},o.id))}),e.jsxs(m.div,{variants:ie,children:[e.jsx("label",{className:"block mb-1 font-semibold text-gray-300",children:x.summary}),e.jsx("textarea",{value:h,onChange:o=>$(o.target.value),className:"w-full bg-gray-700 p-2 rounded-md border border-gray-600",rows:4,placeholder:i==="ar"?"أضف ملخصًا أو ملاحظات عامة (اختياري)...":"Add a summary or general notes (optional)..."})]}),e.jsx(m.div,{variants:ie,children:e.jsxs("div",{className:"bg-gray-900/50 border border-yellow-400/50 rounded-lg p-6 mt-4",children:[e.jsx("h2",{className:"text-xl font-bold text-[#FFD700] mb-4 text-center",children:i==="ar"?"النتيجة الإجمالية":"Overall Score"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(ze,{rating:H,language:i}),e.jsx("span",{className:"text-lg text-gray-300",children:qe(H,i)}),e.jsxs("div",{className:"relative mt-4 flex flex-col items-center",children:[e.jsx(m.button,{onClick:()=>Z(r),className:"bg-[#FFD700] text-black px-8 py-3 rounded-lg font-bold disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors",disabled:z||!S||!A,variants:L,whileHover:"hover",whileTap:"tap",children:z?i==="ar"?"جاري الحفظ...":"Saving...":x.save}),e.jsxs(ce,{children:[!S&&e.jsxs(m.div,{variants:oe,initial:"initial",animate:"animate",exit:"exit",className:"mt-3 flex items-center gap-2 text-sm text-red-400",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:_[i].permissionNeededForAction})]}),!A&&e.jsxs(m.div,{variants:oe,initial:"initial",animate:"animate",exit:"exit",className:"mt-3 flex items-center gap-2 text-sm text-red-400",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:x.noSignatureMessage})]})]})]})]})]})})]}):e.jsxs(m.div,{variants:oe,className:"text-center py-10",children:[e.jsx(de,{className:"h-12 w-12 mx-auto text-yellow-400"}),e.jsx("p",{className:"mt-4 text-lg font-semibold text-yellow-300",children:x.noEvaluations})]})})}function Xe(){const{language:a}=xe(),{user:r,hasPermission:u,isLoading:d}=Ee(),{showDialog:c}=Me(),{setPageLoading:h}=Ce(),{showActionLoading:$,hideActionLoading:Z}=_e(),z=Fe(),{isDirty:N,setIsDirty:v}=De(),[_,G]=n.useState(null),[y,S]=n.useState([]),[A,i]=n.useState(""),[x,H]=n.useState(!1),q=n.useRef([]),[O,ee]=n.useState(null),[Q,o]=n.useState(null),[g,E]=n.useState(!1),pe=u("sss:1"),ye=!!r?.signature_url,R=n.useMemo(()=>({ar:{pageTitle:"تقييم جديد",noSignatureTitle:"التوقيع مطلوب",noSignatureMessage:"يجب عليك رفع توقيعك في ملفك الشخصي أولاً قبل إنشاء تقييم جديد.",confirmSaveTitle:"تأكيد الحفظ",confirmSaveMessage:"هل أنت متأكد من حفظ هذا التقييم وإرساله للاعتماد؟",validationErrorTitle:"بيانات غير مكتملة",validationErrorMessage:"يرجى تقييم كل الأسئلة قبل المتابعة.",successTitle:"نجاح",successMessage:"تم حفظ التقييم بنجاح.",errorTitle:"خطأ",genericErrorMessage:"حدث خطأ أثناء حفظ التقييم.",savingMessage:"جاري حفظ التقييم وإنشاء المهمة",companyEvaluatedTitle:"تم التقييم بالفعل",companyEvaluatedMessage:"لقد تم تقييم هذه الشركة من قبل مستخدم آخر، سيتم تحديث القائمة.",permissionNeededForAction:"لا تملك صلاحية حفظ وإرسال التقييم.",permissionDeniedOnSubmitTitle:"تم رفض الإجراء",permissionDeniedOnSubmitMessage:"لقد تغيرت صلاحياتك ولم يعد بإمكانك تنفيذ هذا الإجراء. سيتم تحديث الصفحة.",common:{company:"الشركة",month:"الشهر",guardCount:"عدد الحراس",violationsCount:"عدد المخالفات",contractNo:"رقم العقد",summary:"الملخص العام",save:"حفظ وإرسال للاعتماد",noEvaluations:"تم تقييم جميع الشركات للشهر السابق."}},en:{pageTitle:"New Evaluation",noSignatureTitle:"Signature Required",noSignatureMessage:"You must upload your signature in your profile before creating a new evaluation.",confirmSaveTitle:"Confirm Save",confirmSaveMessage:"Are you sure you want to save this evaluation and submit it for approval?",validationErrorTitle:"Incomplete Data",validationErrorMessage:"Please rate all questions before proceeding.",successTitle:"Success",successMessage:"Evaluation saved successfully.",errorTitle:"Error",genericErrorMessage:"An error occurred while saving the evaluation.",savingMessage:"Saving evaluation and creating task",companyEvaluatedTitle:"Already Evaluated",companyEvaluatedMessage:"This company has been evaluated by another user. The list will be updated.",permissionNeededForAction:"You do not have permission to save and submit the evaluation.",permissionDeniedOnSubmitTitle:"Action Denied",permissionDeniedOnSubmitMessage:"Your permissions have changed, and you can no longer perform this action. The page will be updated.",common:{company:"Company",month:"Month",guardCount:"Guards Count",violationsCount:"Violations Count",contractNo:"Contract No.",summary:"General Summary",save:"Save & Submit for Approval",noEvaluations:"All companies have been evaluated for the previous month."}}}),[a]),f=R[a],[te,P]=se(n.useMemo(()=>he(ne(re,"companies").withConverter(Pe),Te("type","==","security")),[])),[b,ae]=se(ne(re,"security_questions").withConverter(Ye)),[F,Y]=se(n.useMemo(()=>he(ne(re,"security_evaluations").withConverter(Be),Ae("created_at","desc")),[])),be=n.useMemo(()=>{if(!F)return new Map;const t=new Map;return F.forEach(s=>{t.has(s.company_id)||t.set(s.company_id,s)}),t},[F]),p=n.useMemo(()=>{if(!te||!F)return[];const t=new Date;t.setMonth(t.getMonth()-1);const s=t.getMonth()+1,l=t.getFullYear();return te.filter(w=>{const j=F.filter(V=>V.company_id===w.id&&V.evaluation_year===l&&V.evaluation_month===s);return j.length===0?!0:!j.some(V=>V.status!=="Rejected")})},[te,F]),J=n.useMemo(()=>b?b.map(t=>({id:t.id,text:t.question_text_ar,ratingValue:0,note:""})):[],[b]),K=n.useCallback(()=>{i(""),S(J),v(!1)},[J,v]);n.useEffect(()=>{const t=y.some(j=>j.ratingValue>0),s=y.some(j=>X(j.note).length>0),l=X(A).length>0;return v(t||s||l),()=>{v(!1)}},[y,A,v]),n.useEffect(()=>{const t=s=>{N&&(s.preventDefault(),s.returnValue="")};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[N]);const D=n.useCallback(t=>{if(!t){G(null);return}const s=F?.find(w=>w.company_id===t.id&&w.status!=="Rejected"),l=new Date;s?l.setFullYear(s.evaluation_year,s.evaluation_month-1,1):l.setMonth(l.getMonth()-1),ee(l.getMonth()+1),o(l.getFullYear()),G(t)},[F]);n.useEffect(()=>{d||P||ae||Y||g||(b&&S(J),p.length>0&&D(p[0]),E(!0))},[d,P,ae,Y,g,b,p,J,D]),n.useEffect(()=>{y.length>0&&b&&S(t=>t.map(s=>{const l=b.find(w=>w.id===s.id);return l?{...s,text:a==="ar"?l.question_text_ar:l.question_text_en}:s}))},[a,b]),n.useEffect(()=>{!P&&!Y&&_&&!x&&(p.some(s=>s.id===_.id)||c({variant:"alert",title:R[a].companyEvaluatedTitle,message:R[a].companyEvaluatedMessage,onConfirm:()=>{p.length>0?(D(p[0]),K()):G(null)}}))},[p,_,P,Y,D,c,a,R,K,x]);const we=(t,s,l)=>{S(w=>w.map((j,I)=>I===t?{...j,[s]:l,invalid:!1,shake:!1}:j))},je=async t=>{if(!r?.signature_url){c({variant:"alert",title:f.noSignatureTitle,message:f.noSignatureMessage});return}if(!u("sss:1")){c({variant:"alert",title:f.permissionDeniedOnSubmitTitle,message:f.permissionDeniedOnSubmitMessage});return}if(!t||!r||Q===null||O===null)return;const s=be.get(t.id),l=new Date;l.setMonth(l.getMonth()-1);const w=l.getMonth()+1,j=l.getFullYear();if(s&&s.evaluation_year===j&&s.evaluation_month===w&&s.status!=="Rejected"){c({variant:"alert",title:R[a].companyEvaluatedTitle,message:R[a].companyEvaluatedMessage,onConfirm:()=>{p.length>0?(D(p[0]),K()):G(null)}});return}const I=y.reduce((M,T,k)=>(T.ratingValue===0&&M.push(k),M),[]);if(I.length>0){S(M=>M.map(T=>({...T,invalid:!1,shake:!1}))),setTimeout(()=>{const M=I[0],T=q.current[M];T&&T.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{S(k=>k.map((B,W)=>({...B,invalid:I.includes(W)}))),setTimeout(()=>{S(k=>k.map((B,W)=>({...B,shake:I.includes(W)})))},300)},400)},50);return}const V=async()=>{H(!0),v(!1),$(f.savingMessage);try{const M=await Ge(),T=parseFloat((y.reduce((C,U)=>C+U.ratingValue,0)/y.length).toFixed(2));if(!b)throw new Error("Question data not loaded.");const k=y.map(C=>({question_id:C.id,rating:C.ratingValue,note:X(C.note),question_text_ar:b.find(U=>U.id===C.id)?.question_text_ar||"",question_text_en:b.find(U=>U.id===C.id)?.question_text_en||""})),B={company_id:t.id,evaluation_year:Q,evaluation_month:O,historical_contract_no:t.contract_no,historical_guard_count:t.guard_count,historical_violations_count:t.violations_count,summary:X(A),overall_score:T,details:k};await Oe(Qe,"createEvaluationAndTask")({evaluationData:B,clientContext:M});const ge=p.filter(C=>C.id!==t.id);ge.length>0?D(ge[0]):D(null),K(),c({variant:"success",title:f.successTitle,message:f.successMessage,onConfirm:()=>{z("/tasks")}})}catch(M){c({variant:"alert",title:f.errorTitle,message:M.message||f.genericErrorMessage})}finally{Z(),H(!1)}};c({variant:"confirm",title:f.confirmSaveTitle,message:f.confirmSaveMessage,onConfirm:()=>{V()}})},Ne=d||P||ae||Y;n.useEffect(()=>{h(!g)},[g,h]);const Se=!Ne&&p.length===0;return e.jsx(ce,{mode:"wait",children:e.jsx(m.div,{custom:a,variants:Re,initial:"initial",animate:"animate",exit:"exit",children:Se?e.jsx("div",{className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl p-6 border border-gray-700",children:e.jsxs("div",{className:"text-center py-10",children:[e.jsx(de,{className:"h-12 w-12 mx-auto text-yellow-400"}),e.jsx("p",{className:"mt-4 text-lg font-semibold text-yellow-300",children:f.common.noEvaluations})]})}):e.jsx(Je,{companiesForEval:p,selectedCompany:_,onCompanyChange:D,questions:y,onQuestionChange:we,summary:A,onSummaryChange:i,onSubmit:je,isSubmitting:x,targetYear:Q,targetMonth:O,translations:R,questionsRefs:q,showDialog:c,userHasSignature:ye,canPerformSaveAction:pe})},a)})}export{Xe as default};
