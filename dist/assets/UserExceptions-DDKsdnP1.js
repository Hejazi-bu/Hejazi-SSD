import{u as me,a as he,b as fe,d as xe,f as be,al as ve,r as a,q,w as O,h as S,am as pe,an as z,k as e,A as Se,m as _,l as H,ao as ye,H as we,at as G,ap as je,s as _e,ar as Ne,D as Ue,au as Te,N as M}from"./index-DjQnKye2.js";import{u as Fe}from"./useAccessManager-ByKSRh3L.js";import{S as Ce}from"./DelegationTree-BM3T4QwY.js";import{F as Me}from"./AdjustmentsHorizontalIcon-C5lpyWEE.js";import"./ChevronDownIcon-qIRIwReu.js";import"./ChevronRightIcon-B_NjU3cg.js";import"./CogIcon-CQGT2rf7.js";import"./PencilIcon-u-NC4gBe.js";const y=pe(),Pe=Te(),Ee={ar:{pageTitle:"إدارة صلاحيات المستخدمين (الاستثناءات)",selectUserTitle:"اختيار المستخدم",searchPlaceholder:"ابحث عن مستخدم...",filterTreePlaceholder:"بحث داخل الخدمات...",noUsersFound:"لم يتم العثور على مستخدمين ضمن نطاق إدارتك.",save:"حفظ الاستثناءات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث استثناءات المستخدم.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeUser:"تغيير المستخدم",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingUsers:"جاري جلب قائمة الموظفين...",conflictTitle:"تحديث خارجي",conflictMessage:"قام مستخدم آخر بتعديل استثناءات هذا المستخدم. هل تريد تحميل البيانات الجديدة (ستفقد تعديلاتك)؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Manage User Permissions (Exceptions)",selectUserTitle:"Select User",searchPlaceholder:"Search user...",filterTreePlaceholder:"Search services...",noUsersFound:"No users found in your scope.",save:"Save Exceptions",saving:"Saving...",successTitle:"Success",successMessage:"User exceptions updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeUser:"Change User",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingUsers:"Fetching users...",conflictTitle:"External Update",conflictMessage:"Another user updated these exceptions. Load new data (you will lose current changes)?",loadNew:"Load New",ignore:"Ignore"}},$e=({user:c,onClick:r,language:N})=>e.jsx(_.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:r,className:"bg-gray-800/50 border border-gray-700 hover:border-[#FFD700]/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-[#FFD700] transition-colors overflow-hidden border border-gray-600",children:c.avatar_url?e.jsx("img",{src:c.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:N==="ar"?c.name_ar:c.name_en}),e.jsx("p",{className:"text-xs text-gray-500",children:N==="ar"?c.job?.name_ar:c.job?.name_en})]})]})});function He(){const{language:c}=me(),r=Ee[c],{canManageScope:N,canGrantResource:U}=he(),{updateUserPermissions:V}=Fe(),{showDialog:b}=fe(),{showActionLoading:W,hideActionLoading:B}=xe(),{setIsDirty:w}=be(),[De,P]=ve(),[K,Q]=a.useState([]),[E,X]=a.useState([]),[v,$]=a.useState(null),[h,Y]=a.useState(null),[T,Z]=a.useState(""),[j,D]=a.useState(""),[k,A]=a.useState(new Set),[p,F]=a.useState(new Map),[f,I]=a.useState(new Map),[ee,R]=a.useState(!0);a.useEffect(()=>{(async()=>{R(!0);try{const i=(await Ue(Pe,"getMyManagedUsers")()).data;Q(i);const[l,m,o]=await Promise.all([M(S(y,"services")),M(S(y,"sub_services")),M(S(y,"sub_sub_services"))]),d=c==="ar"?"label_ar":"label_en",ce=l.docs.map(t=>({...t.data(),id:t.data().id??t.id})),oe=m.docs.map(t=>({...t.data(),id:t.data().id??t.id})),de=o.docs.map(t=>({...t.data(),id:t.data().id??t.id})),ue=ce.map(t=>{const C=oe.filter(g=>String(g.service_id)===String(t.id)).map(g=>({id:`ss:${g.id}`,label:g[d],parentId:`s:${t.id}`,type:"page",children:[]})),ge=de.filter(g=>String(g.service_id)===String(t.id)).map(g=>({id:`sss:${g.id}`,label:g[d],parentId:`s:${t.id}`,type:"action",children:[]}));return{id:`s:${t.id}`,label:t[d],type:"service",children:[...C,...ge].sort((g,ke)=>g.type==="page"?-1:1)}}).sort((t,C)=>t.id.toString().localeCompare(C.id.toString(),void 0,{numeric:!0}));X(ue)}catch(n){console.error("Error fetching users:",n),b({title:r.errorTitle,message:"فشل في تحميل قائمة الموظفين.",variant:"error"})}finally{R(!1)}})()},[c,r.errorTitle,b]);const x=a.useMemo(()=>{if(p.size!==f.size)return!0;for(const[s,n]of p)if(f.get(s)!==n)return!0;return!1},[p,f]);a.useEffect(()=>w(x),[x,w]);const L=a.useRef(x);a.useEffect(()=>{L.current=x},[x]),a.useEffect(()=>{if(!v||!h)return;let s=()=>{};if(h.job_id){const i=q(S(y,"job_permissions"),O("job_id","==",Number(h.job_id)||h.job_id));s=z(i,l=>{const m=new Set;l.forEach(o=>{const d=o.data();d.sub_sub_service_id?m.add(`sss:${d.sub_sub_service_id}`):d.sub_service_id?m.add(`ss:${d.sub_service_id}`):d.service_id&&m.add(`s:${d.service_id}`)}),A(m)})}else A(new Set);const n=q(S(y,"user_permissions"),O("user_id","==",v)),u=z(n,i=>{if(i.metadata.hasPendingWrites)return;const l=new Map;if(i.forEach(m=>{const o=m.data(),d=o.sub_sub_service_id?`sss:${o.sub_sub_service_id}`:o.sub_service_id?`ss:${o.sub_service_id}`:`s:${o.service_id}`;l.set(d,o.is_allowed)}),L.current){const m=JSON.stringify(Array.from(f.entries()).sort()),o=JSON.stringify(Array.from(l.entries()).sort());m!==o&&b({variant:"alert",title:r.conflictTitle,message:r.conflictMessage,confirmText:r.loadNew,cancelText:r.ignore,onConfirm:()=>{F(l),I(new Map(l))}})}else F(l),I(new Map(l))});return()=>{s(),u()}},[v,h,f,r,b]);const se=s=>{$(s.id),Y(s),D(""),w(!1),P({userId:s.id})},re=a.useCallback(s=>p.get(s),[p]),ae=a.useCallback(s=>k.has(s),[k]),te=a.useCallback(s=>f.get(s),[f]),ie=a.useCallback((s,n)=>{F(u=>{const i=new Map(u);return n===void 0?i.delete(s):i.set(s,n),i})},[]),ne=async()=>{if(!v||!x)return;const s=[];if(p.forEach((n,u)=>{const i=f.get(u);n!==i&&n!==void 0&&s.push({id:u,state:n})}),s.length!==0){W(r.saving);try{await V(v,s),b({variant:"success",title:r.successTitle,message:r.successMessage})}catch{b({variant:"alert",title:r.errorTitle,message:r.errorMessage})}finally{B()}}},J=K.filter(s=>s.name_ar?.includes(T)||s.name_en?.includes(T)),le=a.useMemo(()=>{const s=n=>n.reduce((u,i)=>{if(!U(i.id))return u;const l=s(i.children);return(i.label.toLowerCase().includes(j.toLowerCase())||l.length>0)&&u.push({...i,children:l}),u},[]);return s(E)},[E,j,U]);return ee?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:r.loadingUsers}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(Se,{mode:"wait",children:v?e.jsxs(_.div,{variants:H,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 space-y-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500",children:h?.avatar_url?e.jsx("img",{src:h.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:c==="ar"?h?.name_ar:h?.name_en}),e.jsx("p",{className:"text-xs text-gray-400",children:r.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{$(null),w(!1),P({})},className:"text-sm text-blue-400 hover:underline flex items-center gap-1",children:[e.jsx(je,{className:"w-4 h-4"})," ",r.changeUser]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:r.filterTreePlaceholder,value:j,onChange:s=>D(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(Me,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})]}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(_.div,{variants:_e,initial:"initial",animate:"animate",children:le.map(s=>e.jsx(Ce,{node:s,getState:re,getJobState:ae,getInitialState:te,onToggle:ie,canEdit:U,t:r,searchTerm:j,rowType:"user"},s.id))})}),e.jsx("div",{className:"flex justify-center pb-10 mt-auto",children:e.jsxs("button",{disabled:!x,onClick:()=>b({variant:"confirm",title:r.confirmSave,message:r.confirmSave,onConfirm:ne}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${x?"bg-[#FFD700] text-black hover:scale-105":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(Ne,{className:"w-6 h-6"})," ",r.save]})})]},"editor"):e.jsx(_.div,{variants:H,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 text-[#FFD700]",children:[e.jsx(ye,{className:"w-6 h-6"}),e.jsx("h2",{className:"text-xl font-bold",children:r.selectUserTitle})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:r.searchPlaceholder,value:T,onChange:s=>Z(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-[#FFD700] transition-colors text-white"}),e.jsx(we,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),J.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:J.map(s=>e.jsx($e,{user:s,language:c,onClick:()=>se(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:e.jsx("p",{children:r.noUsersFound})})]})},"select")})})}export{He as default};
