import{u as te,a as se,c as ae,b as ne,d as re,r,T as V,k as e,A as z,m as g,l as oe,s as ie,x as B,H as le,z as G,F as O,I as ce,J as de,K as ue,G as me,n as H,L as ge,M as pe,N as C,q as xe,h as E,i as T}from"./index-DjQnKye2.js";import{F as he,a as fe}from"./ArrowUpIcon-DLBO0jt9.js";import{F as ve}from"./CalendarIcon-COYbbu5Y.js";import{F as ye}from"./ChevronDownIcon-qIRIwReu.js";function D({Icon:n,label:i,value:d,colorClass:h="text-gray-300"}){return e.jsxs("div",{className:"flex flex-col text-start",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-gray-400 font-semibold mb-1",children:[e.jsx(n,{className:"w-4 h-4"}),e.jsx("span",{children:i})]}),e.jsx("span",{className:`font-bold text-base break-words ${h}`,children:d})]})}function we(n,i){const d=Math.round(n);return{ar:["","تحتاج إلى تحسين","مقبول","جيد","جيد جداً","ممتاز"],en:["","Need improvement","Acceptable","Good","Very Good","Excellent"]}[i][d]||""}const U=n=>{try{return new Intl.NumberFormat("en-US",{useGrouping:!1}).format(Number(n))}catch{return String(n)}};function be({options:n,selected:i,onChange:d,title:h,translations:f}){const[y,j]=r.useState(!1),v=r.useRef(null),A=l=>{const w=i.includes(l)?i.filter(R=>R!==l):[...i,l];d(w)};r.useEffect(()=>{function l(w){v.current&&!v.current.contains(w.target)&&j(!1)}return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[v]);const N=i.length===0?f.all:`${i.length} ${f.selected}`;return e.jsxs("div",{className:"relative",ref:v,children:[e.jsxs("button",{onClick:()=>j(!y),className:"flex items-center gap-2 bg-gray-700 p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700]",children:[e.jsxs("span",{children:[h,": ",N]}),e.jsx(ye,{className:`w-4 h-4 transition-transform ${y?"rotate-180":""}`})]}),e.jsx(z,{children:y&&e.jsx(g.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute z-10 mt-2 w-56 bg-gray-800 border border-gray-600 rounded-md shadow-lg p-2 top-full rtl:right-0",children:n.map(l=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-700 rounded-md cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded bg-gray-600 border-gray-500 text-[#FFD700] focus:ring-[#FFD700]",checked:i.includes(l.value),onChange:()=>A(l.value)}),e.jsx("span",{children:l.label})]},l.value))})})]})}function _e(){const{language:n}=te(),{hasPermission:i,isLoading:d}=se(),{setPageLoading:h}=ae(),{showDialog:f}=ne(),{showActionLoading:y,hideActionLoading:j}=re(),[v,A]=r.useState([]),[N,l]=r.useState(!1),[w,R]=r.useState(null),[_,Y]=r.useState(""),[S,J]=r.useState([]),[b,L]=r.useState({key:"created_at",direction:"descending"}),k=r.useMemo(()=>({ar:{searchPlaceholder:"ابحث برقم التسلسل أو اسم الشركة...",noRecords:"لم يتم العثور على تقييمات مطابقة.",errorLoading:"حدث خطأ أثناء تحميل البيانات.",seqNo:"رقم التسلسل",company:"الشركة",evalDate:"تاريخ التقييم",createdDate:"تاريخ الإنشاء",score:"النتيجة",status:"الحالة",viewDetails:"عرض التفاصيل",edit:"تعديل",editingNotAllowedTitle:"غير مسموح بالتعديل",editingNotAllowedMessage:"يمكن تعديل التقييم فقط عندما تكون حالته 'بحاجة لمراجعة'.",permissionMissingTitle:"صلاحية غير كافية",permissionMissingViewMessage:"لا تملك الصلاحية اللازمة لعرض تفاصيل التقييم.",permissionMissingEditMessage:"لا تملك الصلاحية اللازمة لتعديل هذا التقييم.",filterByStatus:"فلترة حسب الحالة",all:"الكل",needsRevision:"بحاجة لمراجعة",awaitingApproval:"بانتظار الاعتماد",approved:"معتمد",Rejected:"مرفوض",sortBy:"فرز حسب",sortDirection:"اتجاه الفرز",selected:"محدد",companyName:"اسم الشركة",preparingPage:"جاري تجهيز الصفحة..."},en:{searchPlaceholder:"Search by sequence no. or company name...",noRecords:"No matching evaluations found.",errorLoading:"An error occurred while loading data.",seqNo:"Seq. No.",company:"Company",evalDate:"Evaluation Date",createdDate:"Creation Date",score:"Score",status:"Status",viewDetails:"View Details",edit:"Edit",editingNotAllowedTitle:"Editing Not Allowed",editingNotAllowedMessage:"An evaluation can only be edited when its status is 'Needs Revision'.",permissionMissingTitle:"Insufficient Permission",permissionMissingViewMessage:"You do not have the required permission to view evaluation details.",permissionMissingEditMessage:"You do not have the required permission to edit this evaluation.",filterByStatus:"Filter by Status",all:"All",needsRevision:"Needs Revision",awaitingApproval:"Awaiting Approval",approved:"Approved",Rejected:"Rejected",sortBy:"Sort by",sortDirection:"Sort Direction",selected:"selected",companyName:"Company Name",preparingPage:"Preparing page..."}}),[n]),t=n==="ar"?k.ar:k.en,$=i("sss:3"),q=i("sss:4");r.useEffect(()=>{h(d||!N)},[d,N,h]),r.useEffect(()=>{if(d)return;(async()=>{try{const[a,u,o]=await Promise.all([C(xe(E(T,"security_evaluations"))),C(E(T,"companies")),C(E(T,"evaluation_history"))]),c=new Map(u.docs.map(x=>[x.id,x.data()])),m=new Map(o.docs.map(x=>[x.id,x.data()])),F=a.docs.map(x=>{const p=x.data(),M=c.get(p.company_id),ee=m.get(p.latest_version_id);return{id:x.id,sequence_number:p.sequence_number||0,company_name:n==="ar"?M?.name_ar:M?.name_en||M?.name_ar||"Unknown",evaluation_year:p.evaluation_year,evaluation_month:p.evaluation_month,evaluation_date:new Date(p.evaluation_year,p.evaluation_month-1),status:p.status,overall_score:ee?.overall_score||0,created_at:p.created_at}});A(F),R(null)}catch(a){console.error("Error fetching evaluation history:",a),R(t.errorLoading)}finally{l(!0)}})()},[d,n,t.errorLoading]);const I=r.useCallback((s,a,u)=>{if(!a){f({variant:"alert",title:t.permissionMissingTitle,message:u});return}y(t.preparingPage);const o=window.open(s,"_blank");setTimeout(()=>{j(),o||f({variant:"alert",title:t.errorLoading,message:"Please allow pop-ups for this site."})},1500)},[f,y,j,t]),K=s=>{I(`/companies/evaluation/details/${s}`,q,t.permissionMissingViewMessage)},Q=(s,a)=>{if(a!=="Needs Revision"){f({variant:"alert",title:t.editingNotAllowedTitle,message:t.editingNotAllowedMessage});return}I(`/companies/evaluation/edit/${s}`,$,t.permissionMissingEditMessage)},W=r.useCallback(s=>{switch(s){case"Needs Revision":return{text:t.needsRevision,color:"text-orange-400"};case"Awaiting Approval":return{text:t.awaitingApproval,color:"text-yellow-400"};case"Approved":return{text:t.approved,color:"text-green-400"};case"Rejected":return{text:t.Rejected,color:"text-red-400"};default:return{text:s,color:"text-gray-400"}}},[t]),P=r.useMemo(()=>{let s=[...v];if(_){const a=_.toLowerCase();s=s.filter(u=>u.company_name.toLowerCase().includes(a)||u.sequence_number.toString().includes(a))}return S.length>0&&(s=s.filter(a=>S.includes(a.status))),s.sort((a,u)=>{const o=a[b.key],c=u[b.key];let m=0;return o instanceof V&&c instanceof V?m=o.toMillis()-c.toMillis():o instanceof Date&&c instanceof Date?m=o.getTime()-c.getTime():typeof o=="string"&&typeof c=="string"?m=o.localeCompare(c):typeof o=="number"&&typeof c=="number"&&(m=o-c),b.direction==="ascending"?m:-m}),s},[v,_,S,b]),X=()=>{L(s=>({...s,direction:s.direction==="ascending"?"descending":"ascending"}))},Z=[{value:"Approved",label:t.approved},{value:"Rejected",label:t.Rejected},{value:"Needs Revision",label:t.needsRevision},{value:"Awaiting Approval",label:t.awaitingApproval}];return e.jsx(z,{mode:"wait",children:e.jsx(g.div,{custom:n,variants:oe,initial:"initial",animate:"animate",exit:"exit",children:N?e.jsxs(g.div,{variants:ie,initial:"initial",animate:"animate",className:"space-y-6",children:[e.jsxs(g.div,{variants:B,className:"bg-gray-800/50 rounded-xl shadow-2xl p-4 border border-gray-700 space-y-4",children:[e.jsx("div",{className:"flex justify-end rtl:justify-start",children:e.jsxs("div",{className:"w-full sm:w-auto relative",children:[e.jsx(le,{className:"w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2 rtl:left-auto rtl:right-3"}),e.jsx("input",{type:"text",placeholder:t.searchPlaceholder,value:_,onChange:s=>Y(s.target.value),className:"w-full sm:w-72 bg-gray-700 py-2 pl-10 pr-3 rtl:pr-10 rtl:pl-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700] transition-colors"})]})}),e.jsx("hr",{className:"border-gray-700"}),e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap items-center gap-4",children:[e.jsx(be,{options:Z,selected:S,onChange:J,title:t.filterByStatus,translations:t}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-semibold text-gray-300",children:[t.sortBy,":"]}),e.jsxs("select",{value:b.key,onChange:s=>L(a=>({...a,key:s.target.value})),className:"bg-gray-700 p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700]",children:[e.jsx("option",{value:"created_at",children:t.createdDate}),e.jsx("option",{value:"evaluation_date",children:t.evalDate}),e.jsx("option",{value:"company_name",children:t.companyName}),e.jsx("option",{value:"overall_score",children:t.score}),e.jsx("option",{value:"sequence_number",children:t.seqNo})]}),e.jsx("button",{onClick:X,title:t.sortDirection,className:"p-2 bg-gray-700 rounded-md border border-gray-600 hover:bg-gray-600 transition-colors",children:b.direction==="ascending"?e.jsx(he,{className:"w-5 h-5"}):e.jsx(fe,{className:"w-5 h-5"})})]})]})]}),e.jsx("div",{className:"space-y-4",children:w?e.jsxs(g.div,{variants:G,className:"bg-red-900/50 border border-red-700 rounded-lg p-6 text-center",children:[e.jsx(O,{className:"h-12 w-12 mx-auto text-red-400"}),e.jsx("p",{className:"mt-4 text-lg font-semibold text-red-300",children:w})]}):P.length===0?e.jsxs(g.div,{variants:G,className:"bg-gray-800/50 rounded-xl p-6 border border-gray-700 text-center",children:[e.jsx(O,{className:"h-12 w-12 mx-auto text-yellow-400"}),e.jsx("p",{className:"mt-4 text-lg font-semibold text-yellow-300",children:t.noRecords})]}):P.map(s=>{const{text:a,color:u}=W(s.status),o={month:"long",year:"numeric",numberingSystem:"latn"},c={dateStyle:"short",timeStyle:"short",numberingSystem:"latn"},m=s.evaluation_date.toLocaleString(n==="ar"?"ar-EG":"en-US",o),F=we(s.overall_score,n);return e.jsx(g.div,{layout:!0,variants:B,className:"bg-gradient-to-br from-gray-900/80 to-gray-800/80 rounded-lg p-4 sm:p-5 shadow-lg border border-gray-700 hover:border-[#FFD700]/30 transition-all duration-300",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-grow grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-x-6 gap-y-4 w-full",children:[e.jsx(D,{Icon:ce,label:t.seqNo,value:U(s.sequence_number),colorClass:"text-white"}),e.jsx(D,{Icon:de,label:t.company,value:s.company_name,colorClass:"text-white"}),e.jsx(D,{Icon:ve,label:t.evalDate,value:m}),e.jsx(D,{Icon:ue,label:t.createdDate,value:s.created_at?.toDate().toLocaleString(n==="ar"?"ar-EG":"en-US",c)||"N/A"}),e.jsx(D,{Icon:me,label:t.score,value:e.jsxs("div",{className:"flex items-baseline gap-2 rtl:flex-row-reverse rtl:justify-end",children:[e.jsx("span",{className:"font-bold text-yellow-400",children:`${U((s.overall_score*20).toFixed(0))}%`}),e.jsxs("span",{className:"text-gray-400 text-sm font-normal",children:["(",F,")"]})]}),colorClass:"text-yellow-400"})]}),e.jsx("div",{className:"w-full sm:w-px sm:h-12 bg-gray-700 self-stretch"}),e.jsxs("div",{className:"flex flex-row sm:flex-col items-center justify-between sm:justify-center gap-3 w-full sm:w-auto sm:min-w-[150px]",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs text-gray-400 font-semibold mb-1",children:t.status}),e.jsx("span",{className:`font-bold text-base text-center ${u}`,children:a})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g.button,{variants:H,whileHover:"hover",whileTap:"tap",onClick:()=>K(s.sequence_number),title:q?t.viewDetails:t.permissionMissingTitle,className:"p-2 text-blue-400 hover:text-blue-300 disabled:text-gray-600/50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ge,{className:"w-5 h-5"})}),s.status==="Needs Revision"&&e.jsx(g.button,{variants:H,whileHover:"hover",whileTap:"tap",onClick:()=>Q(s.sequence_number,s.status),title:$?t.edit:t.permissionMissingTitle,className:"p-2 text-yellow-500 hover:text-yellow-400 disabled:text-gray-600/50 disabled:cursor-not-allowed transition-colors",children:e.jsx(pe,{className:"w-5 h-5"})})]})]})]})},s.id)})})]}):e.jsx("div",{className:"space-y-4 pt-20",children:Array.from({length:5}).map((s,a)=>e.jsx(g.div,{className:"bg-gray-800/50 rounded-xl p-6 border border-gray-700 h-28 animate-pulse"},a))})},n)})}export{_e as default};
