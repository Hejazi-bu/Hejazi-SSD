import{u as le,a as ie,b as de,d as me,f as ue,al as ge,r,q as $,w as k,h as u,am as xe,an as J,k as e,A as fe,m as R,l as q,ao as pe,H as he,at as H,ap as ve,ar as je,N as b}from"./index-DjQnKye2.js";import{u as ye}from"./useAccessManager-ByKSRh3L.js";import{S as be}from"./ScopeRuleBuilder-4RV707eC.js";import{S as Ne}from"./ScopeList-B0c6YktL.js";import{F as we}from"./FunnelIcon-D6Ykaui4.js";import"./PlusIcon-VqZkTY5V.js";import"./UserGroupIcon-1ZI4lWI9.js";import"./TrashIcon-CBwyCsvA.js";const g=xe(),Se={ar:{pageTitle:"نظام تفويض التحكم (استثناءات المستخدمين)",pageDesc:"منح مستخدم محدد صلاحية 'التحكم' في نطاقات (شركات/إدارات) إضافية.",selectUserTitle:"اختر المستخدم",searchPlaceholder:"ابحث عن مستخدم...",noUsersFound:"لا يوجد مستخدمين متاحين في نطاق تحكمك.",save:"حفظ الاستثناءات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث نطاق تحكم المستخدم.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ القواعد؟",changeUser:"تغيير المستخدم",loadingData:"جاري تحميل البيانات...",currentRules:"قواعد الاستثناء الحالية",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل القواعد من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (User Exceptions)",pageDesc:"Grant a specific user 'Control' over additional scopes (Companies/Departments).",selectUserTitle:"Select User",searchPlaceholder:"Search user...",noUsersFound:"No users found in your control scope.",save:"Save Exceptions",saving:"Saving...",successTitle:"Success",successMessage:"User control scope updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save rules?",changeUser:"Change User",loadingData:"Loading data...",currentRules:"Current Exception Rules",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},Ue=({user:n,onClick:s,language:x})=>e.jsx(R.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors overflow-hidden border border-gray-600",children:n.avatar_url?e.jsx("img",{src:n.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(H,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:x==="ar"?n.name_ar:n.name_en}),e.jsx("p",{className:"text-xs text-gray-500",children:x==="ar"?n.job?.name_ar:n.job?.name_en}),e.jsx("p",{className:"text-[10px] text-gray-600 mt-1",children:x==="ar"?n.company?.name_ar:n.company?.name_en})]})]})});function Fe(){const{language:n}=le(),s=Se[n],{canManageScope:x}=ie(),{updateUserControlScope:_}=ye(),{showDialog:h}=de(),{showActionLoading:B,hideActionLoading:G}=me(),{setIsDirty:v}=ue(),[Re,T]=ge(),[V,W]=r.useState([]),[D,z]=r.useState([]),[C,K]=r.useState([]),[I,Q]=r.useState([]),[E,X]=r.useState([]),[M,Y]=r.useState([]),[d,P]=r.useState(null),[N,Z]=r.useState(null),[S,ee]=r.useState(""),[j,F]=r.useState([]),[y,w]=r.useState([]),[se,U]=r.useState(!0);r.useEffect(()=>{(async()=>{U(!0);try{const c=J(u(g,"users"),t=>{const ce=t.docs.map(p=>({id:p.id,...p.data()})).filter(p=>x("control",{userId:p.id,companyId:p.company_id,jobId:String(p.job_id)}));W(ce)}),[m,l,o,f,O]=await Promise.all([b(u(g,"jobs")),b($(u(g,"companies"),k("is_allowed","==",!0))),b(u(g,"sectors")),b(u(g,"departments")),b(u(g,"sections"))]);return z(m.docs.map(t=>({id:t.id,...t.data()}))),K(l.docs.map(t=>({id:t.id,...t.data()}))),Q(o.docs.map(t=>({id:t.id,...t.data()}))),X(f.docs.map(t=>({id:t.id,...t.data()}))),Y(O.docs.map(t=>({id:t.id,...t.data()}))),U(!1),()=>c()}catch(c){console.error("Error fetching data:",c),U(!1)}})()},[x]);const i=r.useMemo(()=>JSON.stringify(y)!==JSON.stringify(j),[y,j]);r.useEffect(()=>v(i),[i,v]);const L=r.useRef(i);r.useEffect(()=>{L.current=i},[i]),r.useEffect(()=>{if(!d)return;const a=$(u(g,"control_user_scopes"),k("user_id","==",d)),c=J(a,m=>{if(m.metadata.hasPendingWrites)return;const l=m.docs.map(o=>({docId:o.id,...o.data()}));if(L.current){const o=JSON.stringify(l),f=JSON.stringify(j);o!==f&&h({variant:"alert",title:s.conflictTitle,message:s.conflictMessage,confirmText:s.loadNew,cancelText:s.ignore,onConfirm:()=>{F(l),w(l)}})}else F(l),w(l),v(!1)});return()=>c()},[d,v,s,j,h]);const ae=a=>{P(a.id),Z(a),T({userId:a.id})},te=a=>{w(c=>[...c,{...a,isNew:!0}])},re=a=>{w(c=>c.filter((m,l)=>l!==a))},oe=async()=>{if(!(!d||!i)){B(s.saving);try{const a=j.filter(o=>!y.some(f=>f.docId===o.docId)),c=y.filter(o=>!o.docId),m=a.map(o=>_(d,{},"remove",o.docId)),l=c.map(o=>{const{isNew:f,docId:O,...t}=o;return _(d,t,"add")});await Promise.all([...m,...l]),h({variant:"success",title:s.successTitle,message:s.successMessage})}catch(a){h({variant:"alert",title:s.errorTitle,message:a.message||s.errorMessage})}finally{G()}}},A=V.filter(a=>a.name_ar?.includes(S)||a.name_en?.includes(S));return se?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(fe,{mode:"wait",children:d?e.jsxs(R.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)] overflow-hidden",children:N?.avatar_url?e.jsx("img",{src:N.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(H,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:n==="ar"?N?.name_ar:N?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{P(null),v(!1),T({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"})," ",s.changeUser]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsx(be,{jobs:D,companies:C,sectors:I,departments:E,sections:M,onAddRule:te,t:s}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(we,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(Ne,{rules:y,onRemove:re,jobs:D,companies:C,sectors:I,departments:E,sections:M,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!i,onClick:()=>h({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:oe}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${i?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(je,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(R.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 text-red-400",children:[e.jsx(pe,{className:"w-6 h-6"}),e.jsx("h2",{className:"text-xl font-bold",children:s.selectUserTitle})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:S,onChange:a=>ee(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(he,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),A.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:A.map(a=>e.jsx(Ue,{user:a,language:n,onClick:()=>ae(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noUsersFound})})]})},"select")})})}export{Fe as default};
