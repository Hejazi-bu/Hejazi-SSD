import{r as t,u as Y,b as ee,d as se,f as ae,al as te,q as k,w as L,h as u,am as re,an as oe,k as e,A as ne,m as w,l as P,H as ie,v as _,ap as ce,ar as le,N as p}from"./index-DjQnKye2.js";import{u as de}from"./useAccessManager-ByKSRh3L.js";import{S as me}from"./ScopeList-B0c6YktL.js";import{F as ue}from"./FunnelIcon-D6Ykaui4.js";import"./UserGroupIcon-1ZI4lWI9.js";import"./TrashIcon-CBwyCsvA.js";function ge({title:n,titleId:s,...l},d){return t.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:d,"aria-labelledby":s},l),n?t.createElement("title",{id:s},n):null,t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 0 1-.657.643 48.39 48.39 0 0 1-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 0 1-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 0 0-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 0 1-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 0 0 .657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 0 1-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 0 0 5.427-.63 48.05 48.05 0 0 0 .582-4.717.532.532 0 0 0-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 0 0 .658-.663 48.422 48.422 0 0 0-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 0 1-.61-.58v0Z"}))}const xe=t.forwardRef(ge),g=re(),he={ar:{pageTitle:"إدارة الهيكل التنظيمي للوظائف",pageDesc:"تحديد الشركات والوحدات التنظيمية التي تنتمي إليها كل وظيفة (لتغذية فلاتر التفويض).",selectJobTitle:"اختر الوظيفة المراد ربطها",searchPlaceholder:"ابحث عن وظيفة...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ الروابط الهيكلية",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث روابط الهيكل التنظيمي.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ الروابط الجديدة؟",changeJob:"تغيير الوظيفة",loadingData:"جاري تحميل بيانات الهيكل التنظيمي...",currentRules:"الروابط الهيكلية الحالية"},en:{pageTitle:"Manage Job Organizational Structure",pageDesc:"Define which companies and organizational units each job belongs to (to feed delegation filters).",selectJobTitle:"Select Job to map",searchPlaceholder:"Search job...",noJobsFound:"No jobs found.",save:"Save Structural Links",saving:"Saving...",successTitle:"Success",successMessage:"Organizational structure links updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save new structural links?",changeJob:"Change Job",loadingData:"Loading organizational structure data...",currentRules:"Current Structural Links"}},fe=({job:n,onClick:s,language:l})=>e.jsx(w.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-[#FFD700]/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-[#FFD700] transition-colors border border-gray-600",children:e.jsx(_,{className:"w-6 h-6"})}),e.jsx("div",{children:e.jsx("h3",{className:"font-bold text-gray-100",children:l==="ar"?n.name_ar:n.name_en})})]})});function Se(){const{language:n}=Y(),s=he[n],{manageJobDistribution:l}=de(),{showDialog:d}=ee(),{showActionLoading:C,hideActionLoading:E}=se(),{setIsDirty:x}=ae(),[be,N]=te(),[S,I]=t.useState([]),[M,A]=t.useState([]),[O,z]=t.useState([]),[$,q]=t.useState([]),[H,B]=t.useState([]),[h,D]=t.useState(null),[F,U]=t.useState(null),[j,V]=t.useState(""),[y,W]=t.useState([]),[f,J]=t.useState([]),[Z,T]=t.useState(!0);t.useEffect(()=>{(async()=>{T(!0);try{const[i,m,c,o,v]=await Promise.all([p(u(g,"jobs")),p(k(u(g,"companies"),L("is_allowed","==",!0))),p(u(g,"sectors")),p(u(g,"departments")),p(u(g,"sections"))]);I(i.docs.map(r=>({id:r.id,...r.data()}))),A(m.docs.map(r=>({id:r.id,...r.data()}))),z(c.docs.map(r=>({id:r.id,...r.data()}))),q(o.docs.map(r=>({id:r.id,...r.data()}))),B(v.docs.map(r=>({id:r.id,...r.data()})))}catch(i){console.error("Error fetching structure data:",i),d({title:s.errorTitle,message:"فشل تحميل بيانات الهيكل التنظيمي",variant:"error"})}finally{T(!1)}})()},[s.errorTitle]),t.useEffect(()=>{if(!h)return;const a=k(u(g,"job_distribution"),L("job_id","==",h)),i=oe(a,m=>{const c=m.docs.map(o=>({docId:o.id,...o.data()}));W(c),J(c),x(!1)});return()=>i()},[h,x]);const G=a=>{D(a.id),U(a),N({jobId:a.id})},K=a=>{J(i=>i.filter((m,c)=>c!==a))},b=t.useMemo(()=>JSON.stringify(f)!==JSON.stringify(y),[f,y]);t.useEffect(()=>x(b),[b,x]);const Q=async()=>{if(!(!h||!b)){C(s.saving);try{const a=y.filter(o=>!f.some(v=>v.docId===o.docId)),i=f.filter(o=>!o.docId),m=a.map(o=>l("delete",void 0,o.docId)),c=i.map(o=>{const{isNew:v,docId:r,...X}=o;return l("add",X)});await Promise.all([...m,...c]),d({variant:"success",title:s.successTitle,message:s.successMessage})}catch{d({variant:"alert",title:s.errorTitle,message:s.errorMessage})}finally{E()}}},R=S.filter(a=>a.name_ar?.includes(j)||a.name_en?.includes(j));return Z?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(ne,{mode:"wait",children:h?e.jsxs(w.div,{variants:P,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-[#FFD700] shadow-[0_0_15px_rgba(255,215,0,0.3)]",children:e.jsx(_,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:n==="ar"?F?.name_ar:F?.name_en}),e.jsx("p",{className:"text-xs text-[#FFD700] font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{D(null),x(!1),N({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"})," ",s.changeJob]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(ue,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(me,{rules:f,onRemove:K,jobs:S,companies:M,sectors:O,departments:$,sections:H,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!b,onClick:()=>d({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:Q}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${b?"bg-[#FFD700] text-black hover:scale-105 hover:bg-yellow-400":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(le,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(w.div,{variants:P,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-[#FFD700]",children:[e.jsx(xe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsx("h3",{className:"text-sm font-bold text-white mb-3",children:s.selectJobTitle}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:j,onChange:a=>V(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-[#FFD700] transition-colors text-white"}),e.jsx(ie,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),R.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:R.map(a=>e.jsx(fe,{job:a,language:n,onClick:()=>G(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noJobsFound})})]})},"select")})})}export{Se as default};
