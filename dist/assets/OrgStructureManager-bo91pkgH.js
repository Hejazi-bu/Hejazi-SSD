import{r as s,at as X,b as J,D as Y,u as Z,d as ee,an as A,q as $,o as R,h as I,i as L,k as e,m as q,au as H,A as ae,J as te}from"./index-AlbxRJrk.js";import{F as W,a as se}from"./TrashIcon-DqVoRP7K.js";import{F as re}from"./ChevronDownIcon-BtYLWBft.js";import{F as ne}from"./PencilIcon-DZheH_sc.js";import{F as oe}from"./Squares2X2Icon-CDIfnM1d.js";import{F as le}from"./UserGroupIcon-Q_vkDVVC.js";function ie({title:t,titleId:r,...g},l){return s.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":r},g),t?s.createElement("title",{id:r},t):null,s.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5"}))}const G=s.forwardRef(ie),ce=()=>{const t=X(),{showDialog:r}=J(),[g,l]=s.useState(!1);return{manageOrg:s.useCallback(async c=>{l(!0);try{return!!(await Y(t,"manageOrgStructure")(c)).data.success}catch(m){return console.error("Org Structure Error:",m),r({title:"خطأ في الهيكل الإداري",message:m.message||"حدث خطأ غير متوقع",variant:"error"}),!1}finally{l(!1)}},[t,r]),isSubmitting:g}},T=({node:t,type:r,level:g,children:l,onEdit:h,onDelete:c,onMove:m,onAddChild:p,language:x})=>{const[b,k]=s.useState(!1),v=l&&l.length>0;let i=e.jsx(oe,{className:"w-5 h-5"}),j="text-yellow-500 border-yellow-500/30 bg-yellow-500/5",d=x==="ar"?"قطاع":"Sector";return r==="department"?(i=e.jsx(te,{className:"w-5 h-5"}),j="text-blue-400 border-blue-500/30 bg-blue-500/5",d=x==="ar"?"إدارة":"Department"):r==="section"&&(i=e.jsx(le,{className:"w-5 h-5"}),j="text-green-400 border-green-500/30 bg-green-500/5",d=x==="ar"?"قسم":"Section"),e.jsxs("div",{className:"w-full mb-2",children:[e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border transition-all ${j} hover:bg-opacity-10 group`,children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 cursor-pointer",onClick:()=>k(!b),children:[e.jsx("div",{className:`transition-transform ${b?"rotate-0":"rtl:rotate-180"}`,children:v?e.jsx(re,{className:"w-4 h-4 opacity-50"}):e.jsx("div",{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[i,e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-bold text-gray-100",children:x==="ar"?t.name_ar:t.name_en}),e.jsx("span",{className:"text-[10px] opacity-60 uppercase tracking-wider",children:d})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[r!=="section"&&e.jsx("button",{onClick:()=>p(t,r),className:"p-1.5 hover:bg-white/10 rounded-md text-gray-300",title:"إضافة فرع",children:e.jsx(W,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>h(t,r),className:"p-1.5 hover:bg-blue-500/20 rounded-md text-blue-400",title:"تعديل",children:e.jsx(ne,{className:"w-4 h-4"})}),r!=="sector"&&e.jsx("button",{onClick:()=>m(t,r),className:"p-1.5 hover:bg-orange-500/20 rounded-md text-orange-400",title:"نقل (ترحيل ذكي)",children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>c(t,r),className:"p-1.5 hover:bg-red-500/20 rounded-md text-red-400",title:"حذف",children:e.jsx(se,{className:"w-4 h-4"})})]})]}),e.jsx(ae,{children:b&&v&&e.jsx(q.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"pl-6 rtl:pr-6 border-l-2 border-gray-700/30 ml-4 rtl:mr-4 rtl:border-l-0 rtl:border-r-2 mt-1",children:l})})]})};function pe(){const{language:t}=Z(),{manageOrg:r}=ce(),{showDialog:g}=J(),{showActionLoading:l,hideActionLoading:h}=ee(),[c,m]=s.useState([]),[p,x]=s.useState([]),[b,k]=s.useState([]),[v,i]=s.useState(!1),[j,d]=s.useState(!1),[N,z]=s.useState(null),[S,w]=s.useState("sector"),[C,M]=s.useState("create"),[B,P]=s.useState(null),[o,u]=s.useState({name_ar:"",name_en:"",manager_id:"",new_parent_id:""});s.useEffect(()=>{const a=A($(I(L,"sectors"),R("created_at")),y=>m(y.docs.map(_=>_.data()))),n=A($(I(L,"departments"),R("created_at")),y=>x(y.docs.map(_=>_.data()))),f=A($(I(L,"sections"),R("created_at")),y=>k(y.docs.map(_=>_.data())));return()=>{a(),n(),f()}},[]);const K=()=>{w("sector"),M("create"),u({name_ar:"",name_en:"",manager_id:"",new_parent_id:""}),P(null),i(!0)},F=(a,n)=>{n==="sector"?w("department"):n==="department"&&w("section"),M("create"),P(a.id),u({name_ar:"",name_en:"",manager_id:"",new_parent_id:""}),i(!0)},D=(a,n)=>{z(a),w(n),M("update"),u({name_ar:a.name_ar,name_en:a.name_en,manager_id:a.manager_id||"",new_parent_id:""}),i(!0)},E=(a,n)=>{z(a),w(n),u({name_ar:"",name_en:"",manager_id:"",new_parent_id:""}),d(!0)},O=(a,n)=>{g({variant:"confirm",title:t==="ar"?"حذف العنصر":"Delete Item",message:t==="ar"?`هل أنت متأكد من حذف "${a.name_ar}"؟ لا يمكن التراجع.`:`Delete "${a.name_en}"? This cannot be undone.`,onConfirm:async()=>{l("Deleting..."),await r({type:n,action:"delete",docId:a.id}),h()}})},Q=async()=>{if(!o.name_ar||!o.name_en)return;l("Saving...");const a={type:S,action:C,name_ar:o.name_ar,name_en:o.name_en,manager_id:o.manager_id||null};C==="update"&&(a.docId=N.id),C==="create"&&B&&(a.parent_id=B);const n=await r(a);h(),n&&i(!1)},U=async()=>{if(!o.new_parent_id)return;l("Moving...");const a=await r({type:S,action:"move",docId:N.id,new_parent_id:o.new_parent_id});h(),a&&d(!1)},V=s.useMemo(()=>c.map(a=>e.jsx(T,{node:a,type:"sector",language:t,onEdit:D,onDelete:O,onMove:E,onAddChild:F,children:p.filter(n=>n.sector_id===a.id).map(n=>e.jsx(T,{node:n,type:"department",language:t,onEdit:D,onDelete:O,onMove:E,onAddChild:F,children:b.filter(f=>f.department_id===n.id).map(f=>e.jsx(T,{node:f,type:"section",language:t,onEdit:D,onDelete:O,onMove:E,onAddChild:F},f.id))},n.id))},a.id)),[c,p,b,t]);return e.jsxs("div",{className:"p-6 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white mb-1",children:t==="ar"?"إدارة الهيكل الإداري":"Org. Structure Manager"}),e.jsx("p",{className:"text-gray-400 text-sm",children:t==="ar"?"إدارة القطاعات، الإدارات، والأقسام":"Manage Sectors, Departments, and Sections"})]}),e.jsxs("button",{onClick:K,className:"bg-[#FFD700] text-black px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-yellow-400 transition-colors",children:[e.jsx(W,{className:"w-5 h-5"})," ",t==="ar"?"إضافة قطاع":"Add Sector"]})]}),e.jsxs("div",{className:"bg-gray-900/50 border border-gray-700 rounded-xl p-4 min-h-[500px]",children:[V,c.length===0&&e.jsx("div",{className:"text-center py-20 text-gray-500",children:"No structure defined yet."})]}),v&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4",children:e.jsxs(q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},className:"bg-gray-800 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl",children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:C==="create"?t==="ar"?"إضافة جديد":"Add New":t==="ar"?"تعديل":"Edit"}),e.jsx("button",{onClick:()=>i(!1),children:e.jsx(H,{className:"w-6 h-6 text-gray-500"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 block mb-1",children:"الاسم (عربي)"}),e.jsx("input",{type:"text",value:o.name_ar,onChange:a=>u({...o,name_ar:a.target.value}),className:"w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 block mb-1",children:"Name (English)"}),e.jsx("input",{type:"text",value:o.name_en,onChange:a=>u({...o,name_en:a.target.value}),className:"w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white"})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>i(!1),className:"text-gray-400 px-4 py-2",children:"Cancel"}),e.jsx("button",{onClick:Q,className:"bg-blue-500 text-white px-6 py-2 rounded-lg font-bold",children:"Save"})]})]})}),j&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4",children:e.jsxs(q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},className:"bg-gray-800 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl",children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-orange-400"}),t==="ar"?"ترحيل ذكي":"Smart Migration"]}),e.jsx("button",{onClick:()=>d(!1),children:e.jsx(H,{className:"w-6 h-6 text-gray-500"})})]}),e.jsx("p",{className:"text-sm text-gray-300 mb-4 bg-orange-500/10 border border-orange-500/20 p-3 rounded-lg",children:t==="ar"?`سيتم نقل "${N.name_ar}" وجميع العناصر والموظفين التابعين له إلى الوجهة الجديدة تلقائياً.`:`Moving "${N.name_en}" will automatically migrate all linked items and users to the new destination.`}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"text-xs text-gray-400 block mb-1",children:S==="department"?t==="ar"?"انقل إلى قطاع:":"Move to Sector:":t==="ar"?"انقل إلى إدارة:":"Move to Department:"}),e.jsxs("select",{value:o.new_parent_id,onChange:a=>u({...o,new_parent_id:a.target.value}),className:"w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white",children:[e.jsxs("option",{value:"",children:["-- ",t==="ar"?"اختر الوجهة":"Select Destination"," --"]}),S==="department"?c.map(a=>e.jsx("option",{value:a.id,children:t==="ar"?a.name_ar:a.name_en},a.id)):p.map(a=>e.jsx("option",{value:a.id,children:t==="ar"?a.name_ar:a.name_en},a.id))]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>d(!1),className:"text-gray-400 px-4 py-2",children:"Cancel"}),e.jsx("button",{onClick:U,className:"bg-orange-500 text-white px-6 py-2 rounded-lg font-bold",children:"Confirm Move"})]})]})})]})}export{pe as default};
