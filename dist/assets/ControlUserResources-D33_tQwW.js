import{u as ne,a as le,b as oe,d as ce,f as de,al as ue,r as i,q as ge,w as me,h as y,am as he,an as O,k as e,A as fe,m as _,l as q,ao as xe,H as ve,at as G,ap as pe,s as be,ar as ye,N as D}from"./index-DjQnKye2.js";import{u as we}from"./useAccessManager-ByKSRh3L.js";import{S as Se}from"./DelegationTree-BM3T4QwY.js";import{F as je}from"./AdjustmentsHorizontalIcon-C5lpyWEE.js";import"./ChevronDownIcon-qIRIwReu.js";import"./ChevronRightIcon-B_NjU3cg.js";import"./CogIcon-CQGT2rf7.js";import"./PencilIcon-u-NC4gBe.js";const w=he(),Ne={ar:{pageTitle:"نظام تفويض التحكم (موارد المستخدمين)",pageDesc:"منح مستخدم محدد صلاحية 'التحكم' في موارد إضافية كاستثناء.",selectUserTitle:"اختر المستخدم",searchPlaceholder:"ابحث عن مستخدم...",filterTreePlaceholder:"بحث داخل الخدمات...",noUsersFound:"لا يوجد مستخدمين متاحين في نطاق تحكمك.",save:"حفظ الاستثناءات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد التحكم للمستخدم.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeUser:"تغيير المستخدم",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل البيانات من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (User Resources)",pageDesc:"Grant a specific user 'Control' over extra resources as an exception.",selectUserTitle:"Select User",searchPlaceholder:"Search user...",filterTreePlaceholder:"Search services...",noUsersFound:"No users found in your control scope.",save:"Save Exceptions",saving:"Saving...",successTitle:"Success",successMessage:"User control resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeUser:"Change User",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},_e=({user:d,onClick:a,language:x})=>e.jsx(_.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:a,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors overflow-hidden border border-gray-600",children:d.avatar_url?e.jsx("img",{src:d.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:x==="ar"?d.name_ar:d.name_en}),e.jsx("p",{className:"text-xs text-gray-500",children:x==="ar"?d.job?.name_ar:d.job?.name_en})]})]})});function ke(){const{language:d}=ne(),a=Ne[d],{canManageScope:x,canGrantResource:T}=le(),{updateUserControlResources:P}=we(),{showDialog:v}=oe(),{showActionLoading:J,hideActionLoading:z}=ce(),{setIsDirty:p}=de(),[Te,R]=ue(),[H,K]=i.useState([]),[I,V]=i.useState([]),[h,E]=i.useState(null),[S,W]=i.useState(null),[U,B]=i.useState(""),[j,Q]=i.useState(""),[f,C]=i.useState(new Map),[g,$]=i.useState(new Map),[X,k]=i.useState(!0);i.useEffect(()=>{(async()=>{k(!0);try{const u=O(y(w,"users"),t=>{const M=t.docs.map(n=>({id:n.id,...n.data()})).filter(n=>x("control",{userId:n.id,companyId:n.company_id,jobId:String(n.job_id)}));K(M)}),[o,r,c]=await Promise.all([D(y(w,"services")),D(y(w,"sub_services")),D(y(w,"sub_sub_services"))]),l=d==="ar"?"label_ar":"label_en",b=o.docs.map(t=>({...t.data(),id:t.data().id??t.id})),re=r.docs.map(t=>({...t.data(),id:t.data().id??t.id})),te=c.docs.map(t=>({...t.data(),id:t.data().id??t.id})),ie=b.map(t=>{const N=re.filter(n=>String(n.service_id)===String(t.id)).map(n=>({id:`ss:${n.id}`,label:n[l],parentId:`s:${t.id}`,type:"page",children:[]})),M=te.filter(n=>String(n.service_id)===String(t.id)).map(n=>({id:`sss:${n.id}`,label:n[l],parentId:`s:${t.id}`,type:"action",children:[]}));return{id:`s:${t.id}`,label:t[l],type:"service",children:[...N,...M].sort((n,Ue)=>n.type==="page"?-1:1)}}).sort((t,N)=>t.id.toString().localeCompare(N.id.toString(),void 0,{numeric:!0}));return V(ie),()=>u()}catch(u){console.error(u)}finally{k(!1)}})()},[d,x]);const m=i.useMemo(()=>{if(f.size!==g.size)return!0;for(const s of f.keys())if(!g.has(s))return!0;return!1},[f,g]);i.useEffect(()=>p(m),[m,p]);const A=i.useRef(m);i.useEffect(()=>{A.current=m},[m]),i.useEffect(()=>{if(!h)return;const s=ge(y(w,"control_user_resources"),me("user_id","==",h)),u=O(s,o=>{if(o.metadata.hasPendingWrites)return;const r=new Map;if(o.forEach(c=>{const l=c.data(),b=l.sub_sub_service_id?`sss:${l.sub_sub_service_id}`:l.sub_service_id?`ss:${l.sub_service_id}`:`s:${l.service_id}`;r.set(b,c.id)}),A.current){const c=JSON.stringify(Array.from(g.keys()).sort()),l=JSON.stringify(Array.from(r.keys()).sort());c!==l&&v({variant:"alert",title:a.conflictTitle,message:a.conflictMessage,confirmText:a.loadNew,cancelText:a.ignore,onConfirm:()=>{C(r),$(new Map(r))}})}else C(r),$(new Map(r)),p(!1)});return()=>u()},[h,p,a,g,v]);const Y=s=>{E(s.id),W(s),R({userId:s.id})},Z=i.useCallback(s=>f.has(s)?!0:void 0,[f]),ee=i.useCallback(s=>g.has(s)?!0:void 0,[g]),se=i.useCallback((s,u)=>{C(o=>{const r=new Map(o);return u===!0?r.set(s,"PENDING"):r.delete(s),r})},[]),ae=async()=>{if(!(!h||!m)){J(a.saving);try{const s=[];g.forEach((o,r)=>{f.has(r)||s.push(P(h,{},"remove",o))});const u=[];f.forEach((o,r)=>{if(!g.has(r)){const[c,l]=r.split(":"),b={service_id:c==="s"?l:void 0,sub_service_id:c==="ss"?l:void 0,sub_sub_service_id:c==="sss"?l:void 0};u.push(P(h,b,"add"))}}),await Promise.all([...s,...u]),v({variant:"success",title:a.successTitle,message:a.successMessage})}catch(s){v({variant:"alert",title:a.errorTitle,message:s.message||a.errorMessage})}finally{z()}}},F=H.filter(s=>s.name_ar?.includes(U)||s.name_en?.includes(U)),L=i.useMemo(()=>{const s=u=>u.reduce((o,r)=>{if(!T(r.id))return o;const c=s(r.children);return(r.label.toLowerCase().includes(j.toLowerCase())||c.length>0)&&o.push({...r,children:c}),o},[]);return s(I)},[I,j,T]);return X?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:a.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(fe,{mode:"wait",children:h?e.jsxs(_.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)] overflow-hidden",children:S?.avatar_url?e.jsx("img",{src:S.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:d==="ar"?S?.name_ar:S?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:a.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{E(null),p(!1),R({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"})," ",a.changeUser]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:a.filterTreePlaceholder,value:j,onChange:s=>Q(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-red-500 text-sm text-white"}),e.jsx(je,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(_.div,{variants:be,initial:"initial",animate:"animate",children:L.length>0?L.map(s=>e.jsx(Se,{node:s,getState:Z,getJobState:()=>!1,getInitialState:ee,onToggle:se,canEdit:T,t:a,searchTerm:j,rowType:"user"},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!m,onClick:()=>v({variant:"confirm",title:a.confirmSave,message:a.confirmSave,onConfirm:ae}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${m?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(ye,{className:"w-6 h-6"})," ",a.save]})})]},"editor"):e.jsx(_.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 text-red-400",children:[e.jsx(xe,{className:"w-6 h-6"}),e.jsx("h2",{className:"text-xl font-bold",children:a.selectUserTitle})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:a.searchPlaceholder,value:U,onChange:s=>B(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(ve,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),F.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:F.map(s=>e.jsx(_e,{user:s,language:d,onClick:()=>Y(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:e.jsx("p",{children:a.noUsersFound})})]})},"select")})})}export{ke as default};
