import{u as fe,a as xe,b as ve,d as Se,f as ye,al as je,r as o,q as J,w as T,h as f,am as we,an as _e,k as e,J as Ne,ao as Je,A as Te,m as C,l as Q,ap as Ce,H as De,v as W,aq as Ie,s as Pe,ar as Re,N as v}from"./index-AlbxRJrk.js";import{u as Me}from"./useAccessManager-rkPHho6Y.js";import{S as $e}from"./DelegationTree-DqSkF5PP.js";import{S as Ae}from"./ScopeConfigDialog-ByC8QL7E.js";import{F as Ee}from"./AdjustmentsHorizontalIcon-DPQskVqU.js";import"./ChevronDownIcon-BtYLWBft.js";import"./ChevronRightIcon-CG6pqeHi.js";import"./CogIcon-Cm0Oc8sb.js";import"./PencilIcon-DZheH_sc.js";const x=we(),Le={ar:{pageTitle:"نظام تفويض الوصول (موارد الوظائف)",pageDesc:"تحديد الخدمات والموارد التي تملك هذه الوظيفة حق الوصول إليها أو منحها.",selectJobTitle:"اختر الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ الموارد",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد الوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",configureScope:"تخصيص النطاق",scopeGlobal:"عام (الكل)",companyLabel:"الشركة",sectionLabel:"القسم",distributionNotice:"تظهر هنا فقط الشركات والأقسام التي تم توزيع هذه الوظيفة عليها.",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل البيانات من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Access Delegation (Job Resources)",pageDesc:"Define services and resources this job can access or delegate.",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Resources",saving:"Saving...",successTitle:"Success",successMessage:"Job resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",configureScope:"Configure Scope",scopeGlobal:"Global (All)",companyLabel:"Company",sectionLabel:"Section",distributionNotice:"Only companies/sections where this job is distributed appear here.",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},Fe=({job:b,onClick:i,language:_})=>e.jsx(C.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:i,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors border border-gray-600",children:e.jsx(W,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:_==="ar"?b.name_ar:b.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",b.id]})]})]})});function Ke(){const{language:b}=fe(),i=Le[b],{canManageScope:_,canGrantResource:D}=xe(),{updateJobAccessResources:I}=Me(),{showDialog:P}=ve(),{showActionLoading:K,hideActionLoading:X}=Se(),{setIsDirty:y}=ye(),[ke,F]=je(),[Y,Z]=o.useState([]),[k,ee]=o.useState([]),[se,R]=o.useState([]),[ae,M]=o.useState([]),[p,O]=o.useState(null),[q,te]=o.useState(null),[$,re]=o.useState(""),[N,oe]=o.useState(""),[g,j]=o.useState(new Map),[S,z]=o.useState(new Map),[ie,A]=o.useState(!1),[w,G]=o.useState(null),[ce,V]=o.useState(!0);o.useEffect(()=>{(async()=>{V(!0);try{const a=(await v(f(x,"jobs"))).docs.map(r=>({id:r.id,...r.data()}));Z(a.filter(r=>_("control",{jobId:r.id})));const[t,d,n]=await Promise.all([v(f(x,"services")),v(f(x,"sub_services")),v(f(x,"sub_sub_services"))]),l=b==="ar"?"label_ar":"label_en",u=t.docs.map(r=>({...r.data(),id:r.data().id??r.id})),E=d.docs.map(r=>({...r.data(),id:r.data().id??r.id})),me=n.docs.map(r=>({...r.data(),id:r.data().id??r.id})),be=u.map(r=>{const L=E.filter(m=>String(m.service_id)===String(r.id)).map(m=>({id:`ss:${m.id}`,label:m[l],parentId:`s:${r.id}`,type:"page",children:[]})),he=me.filter(m=>String(m.service_id)===String(r.id)).map(m=>({id:`sss:${m.id}`,label:m[l],parentId:`s:${r.id}`,type:"action",children:[]}));return{id:`s:${r.id}`,label:r[l],type:"service",children:[...L,...he].sort((m,Oe)=>m.type==="page"?-1:1)}}).sort((r,L)=>r.id.toString().localeCompare(L.id.toString(),void 0,{numeric:!0}));ee(be)}catch(c){console.error(c)}finally{V(!1)}})()},[b,_]),o.useEffect(()=>{if(!p){R([]),M([]);return}(async()=>{try{const c=J(f(x,"job_distribution"),T("job_id","==",String(p))),a=await v(c),t=new Set,d=new Set;if(a.forEach(n=>{const l=n.data();l.company_id&&t.add(l.company_id),l.section_id&&d.add(l.section_id)}),t.size>0){const l=(await v(J(f(x,"companies"),T("is_allowed","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>t.has(u.id));R(l)}else R([]);if(d.size>0){const l=(await v(J(f(x,"sections"),T("is_active","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>d.has(u.id));M(l)}else M([])}catch(c){console.error("Error fetching job distribution:",c)}})()},[p]);const h=o.useMemo(()=>{if(g.size!==S.size)return!0;for(const[s,c]of g){const a=S.get(s);if(!a||JSON.stringify(c.scope)!==JSON.stringify(a.scope))return!0}return!1},[g,S]);o.useEffect(()=>y(h),[h,y]);const H=o.useRef(h);o.useEffect(()=>{H.current=h},[h]),o.useEffect(()=>{if(!p)return;const s=J(f(x,"access_job_resources"),T("job_id","==",p)),c=_e(s,a=>{if(a.metadata.hasPendingWrites)return;const t=new Map;a.forEach(d=>{const n=d.data(),l=n.sub_sub_service_id?`sss:${n.sub_sub_service_id}`:n.sub_service_id?`ss:${n.sub_service_id}`:`s:${n.service_id}`,u=n.scope||{};t.set(l,{docId:d.id,scope:{scope_company_id:u.companies?.[0]||null,scope_section_id:u.sections?.[0]||null}})}),H.current?(j(t),z(new Map(t))):(j(t),z(new Map(t)),y(!1))});return()=>c()},[p,y]);const ne=s=>{O(s.id),te(s),F({jobId:s.id})},le=o.useCallback(s=>g.has(s)?!0:void 0,[g]),de=o.useCallback((s,c)=>{j(c===!0?a=>new Map(a).set(s,{docId:null,scope:{scope_company_id:null,scope_section_id:null}}):a=>{const t=new Map(a);return t.delete(s),t})},[]),ue=s=>{w&&(j(c=>{const a=new Map(c),t=a.get(w)||{docId:null};return a.set(w,{...t,scope:s}),a}),A(!1),G(null))},pe=async()=>{if(!(!p||!h)){K(i.saving);try{const s=[];S.forEach((a,t)=>{!g.has(t)&&a.docId&&s.push(I(p,{},"remove",a.docId))});const c=[];g.forEach((a,t)=>{const d=S.get(t);if(!d||JSON.stringify(d.scope)!==JSON.stringify(a.scope)){const[n,l]=t.split(":"),u={companies:a.scope.scope_company_id?[a.scope.scope_company_id]:[],sections:a.scope.scope_section_id?[a.scope.scope_section_id]:[],departments:[]},E={service_id:n==="s"?l:void 0,sub_service_id:n==="ss"?l:void 0,sub_sub_service_id:n==="sss"?l:void 0,scope:u};a.docId&&s.push(I(p,{},"remove",a.docId)),c.push(I(p,E,"add"))}}),await Promise.all([...s,...c]),P({variant:"success",title:i.successTitle,message:i.successMessage})}catch(s){P({variant:"alert",title:i.errorTitle,message:s.message||i.errorMessage})}finally{X()}}},U=Y.filter(s=>s.name_ar?.includes($)||s.name_en?.includes($)),ge=o.useCallback(s=>{if(!g.has(s.id))return null;const t=g.get(s.id)?.scope,d=t?.scope_company_id||t?.scope_section_id;return e.jsx("button",{onClick:n=>{n.stopPropagation(),G(s.id),A(!0)},className:`p-1.5 rounded-md hover:bg-gray-700 transition-colors ${d?"text-orange-400 bg-orange-500/10":"text-gray-600"}`,title:i.configureScope,children:d?e.jsx(Ne,{className:"w-4 h-4"}):e.jsx(Je,{className:"w-4 h-4"})})},[g,i]),B=o.useMemo(()=>{const s=c=>c.reduce((a,t)=>{if(!D(t.id))return a;const d=s(t.children);return(t.label.toLowerCase().includes(N.toLowerCase())||d.length>0)&&a.push({...t,children:d}),a},[]);return s(k)},[k,N,D]);return ce?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:i.loadingData}):e.jsxs("div",{className:"w-full flex flex-col min-h-screen",children:[e.jsx(Ae,{isOpen:ie,onClose:()=>A(!1),onSave:ue,validCompanies:se,validSections:ae,initialScope:w?g.get(w)?.scope:null,t:i,language:b}),e.jsx(Te,{mode:"wait",children:p?e.jsxs(C.div,{variants:Q,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]",children:e.jsx(W,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:b==="ar"?q?.name_ar:q?.name_en}),e.jsx("p",{className:"text-xs text-blue-400 font-medium",children:i.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{O(null),y(!1),F({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(Ie,{className:"w-4 h-4"})," ",i.changeJob]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:i.filterTreePlaceholder,value:N,onChange:s=>oe(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(Ee,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(C.div,{variants:Pe,initial:"initial",animate:"animate",children:B.length>0?B.map(s=>e.jsx($e,{node:s,getState:le,getJobState:()=>!1,getInitialState:()=>S.has(s.id),onToggle:de,canEdit:D,t:i,searchTerm:N,rowType:"job",renderScopeButton:ge},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!h,onClick:()=>P({variant:"confirm",title:i.confirmSave,message:i.confirmSave,onConfirm:pe}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${h?"bg-blue-500 text-white hover:scale-105 hover:bg-blue-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(Re,{className:"w-6 h-6"})," ",i.save]})})]},"editor"):e.jsx(C.div,{variants:Q,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-blue-400",children:[e.jsx(Ce,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:i.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:i.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:i.searchPlaceholder,value:$,onChange:s=>re(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(De,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),U.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:U.map(s=>e.jsx(Fe,{job:s,language:b,onClick:()=>ne(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:i.noJobsFound})})]})},"select")})]})}export{Ke as default};
