import{u as z,a as G,c as J,aD as O,e as W,b as X,r as o,h as M,i as $,q as v,o as D,w as y,g as Z,aE as H,ar as V,k as e,A as ee,m,l as se,s as P,J as ae,as as te,aF as re,N as q,aG as ne,I as ie,z as A,n as _,x as oe,aH as le,K as ce,aI as de,L as me}from"./index-AlbxRJrk.js";const U=()=>({toFirestore:r=>r,fromFirestore:(r,n)=>({id:r.id,...r.data(n)})}),ge=U(),ue=U(),pe=({task:r,taskTitle:n,reference:T,targetName:p,targetIcon:h,language:g,href:u})=>{const w=h;return e.jsx(m.div,{variants:{...oe,..._},whileHover:"hover",className:"w-full text-start bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 sm:p-4 shadow-md border border-gray-700 hover:border-[#FFD700]/30 transition-colors duration-300",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow flex items-start gap-3 sm:gap-4",children:[e.jsx("div",{className:"flex-shrink-0 bg-gray-800 p-2 sm:p-3 rounded-lg mt-1",children:e.jsx(H,{className:"w-5 h-5 sm:w-6 sm:h-6 text-[#FFD700]"})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:"text-md sm:text-lg font-bold text-white",children:n}),e.jsxs("div",{className:"mt-2 text-xs sm:text-sm text-gray-400 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:T})]}),e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-gray-300",children:[e.jsx(w,{className:"w-4 h-4"}),e.jsx("span",{children:p})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:r.created_at?.toDate().toLocaleString(g==="ar"?"ar-EG":"en-US",{day:"2-digit",month:"long",year:"numeric",numberingSystem:"latn"})})]})]})]})]}),e.jsx(m.div,{variants:_,whileHover:{..._.hover},whileTap:{..._.tap},children:e.jsx(de,{to:u,title:g==="ar"?"فتح المهمة":"Open Task",className:"flex-shrink-0 p-2 text-gray-400 hover:text-[#FFD700] rounded-full",children:e.jsx(me,{className:"w-5 h-5 sm:w-6 sm:h-6"})})})]})})},he=({hasCompletedTasks:r,translations:n,loading:T})=>{const{IconComponent:p,title:h,message:g,color:u}=o.useMemo(()=>r===!0?{IconComponent:ie,title:n.allTasksCompletedTitle,message:n.allTasksCompletedMessage,color:"text-green-400"}:{IconComponent:V,title:n.noTasksTitle,message:n.noTasksMessage,color:"text-gray-400"},[r,n]);return T||r===null?e.jsx(m.div,{variants:A,className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl p-6 border border-gray-700",children:e.jsx("div",{className:"text-center py-10",children:e.jsx("p",{className:"text-gray-400",children:n.loading})})}):e.jsx(m.div,{variants:A,className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl p-6 border border-gray-700",children:e.jsxs("div",{className:"text-center py-10 flex flex-col items-center",children:[e.jsx(m.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1,type:"spring",stiffness:200,damping:15},children:e.jsx(p,{className:`h-16 w-16 mx-auto ${u}`})}),e.jsx("h3",{className:"mt-4 text-xl font-bold text-white",children:h}),e.jsx("p",{className:"mt-2 text-md text-gray-400 max-w-sm",children:g})]})})};function we(){const{language:r}=z(),{user:n,hasPermission:T,isLoading:p}=G(),{setPageLoading:h}=J(),{getFullPagePath:g,getServiceByKey:u}=O(),w=W(),{showDialog:b}=X(),j=o.useRef(),d=o.useMemo(()=>({ar:{pageTitle:"المهام المعلقة",loading:"جاري تحميل المهام...",noTasksTitle:"لا توجد مهام",noTasksMessage:"ليس لديك أي مهام معلقة في الوقت الحالي.",allTasksCompletedTitle:"أحسنت!",allTasksCompletedMessage:"لقد أنجزت جميع مهامك المعلقة. صفحتك نظيفة الآن.",referenceLabel:"المرجع:",targetLabel:"الهدف:",newTaskTitle:"مهمة جديدة",newTaskMessage:"تم إسناد مهمة جديدة لك:",taskCompletedTitle:"مهمة مُنجزة",taskCompletedMessage:"تم إنجاز المهمة التالية:",taskTitles:{"sss:1":"إنشاء تقييم جديد","sss:2":"اعتماد تقييم","sss:3":"تعديل تقييم","sss:13":"إنشاء مستخدم جديد","sss:14":"اعتماد مستخدم جديد","sss:15":"تعديل طلب مستخدم"}},en:{pageTitle:"Pending Tasks",loading:"Loading tasks...",noTasksTitle:"No Tasks",noTasksMessage:"You do not have any pending tasks at this time.",allTasksCompletedTitle:"All Done!",allTasksCompletedMessage:"You have completed all your pending tasks. Your list is clear.",referenceLabel:"Ref:",targetLabel:"Target:",newTaskTitle:"New Task",newTaskMessage:"A new task has been assigned to you:",taskCompletedTitle:"Task Completed",taskCompletedMessage:"The following task has been completed:",taskTitles:{"sss:1":"Create New Evaluation","sss:2":"Approve Evaluation","sss:3":"Revise Evaluation","sss:13":"Create New User Request","sss:14":"Approve New User","sss:15":"Revise User Request"}}}),[r])[r],[B,F]=o.useState(!0),[L,E]=o.useState(!0),[K,N]=o.useState(null),[xe,S]=o.useState({users:new Map,companies:new Map}),Q=o.useMemo(()=>{if(!n)return null;const s=M($,"tasks_queue").withConverter(ge);return n.is_super_admin?v(s,y("status","==","pending"),D("created_at","desc")):v(s,y("assigned_to_user_ids","array-contains",n.id),y("status","==","pending"),D("created_at","desc"))},[n]),[i,f,ye]=Z(Q);o.useEffect(()=>{if(!n)return;(async()=>{E(!0);try{const a=v(M($,"tasks_history"),y("actor_user_id","==",n.id),re(1));(await q(a)).empty?N(!1):N(!0)}catch(a){console.error("Error checking task history:",a),N(!1)}finally{E(!1)}})()},[n]),o.useEffect(()=>{if(f)return;if(!i||i.length===0){S({users:new Map,companies:new Map}),F(!1);return}(async()=>{const a=new Set;i.forEach(c=>{c.service_id===5&&a.add(c.target_entity_id),c.service_id});const l=new Map,t=new Map;if(a.size>0){const c=v(M($,"companies").withConverter(ue),y(ne(),"in",[...a]));(await q(c)).forEach(R=>t.set(R.id,R.data()))}S({users:l,companies:t}),F(!1)})()},[i,f]);const C=o.useCallback(s=>{const a=`sss:${s.sa_id}`;if(a==="sss:2"||a==="sss:3")return s.sequence_number?`/companies/evaluation/details/${s.sequence_number}`:(console.error("Task Path Error: Task (sss:2/3) is missing sequence_number"),"#");if(a==="sss:14"||a==="sss:15")return s.parent_entity_id?`/system/users/details/${s.parent_entity_id}`:(console.error("Task Path Error: Task (sss:14/15) is missing parent_entity_id"),"#");const l=g(a);if(l)return l;const t=u(a);return t&&t.page?(console.warn(`Could not build full path for ${a}, returning direct page: ${t.page}`),t.page):(console.error(`Task Path Error: No dynamic path found for key ${a}`),"#")},[g,u]);o.useCallback(s=>{const a=C(s);a&&a!=="#"&&w(a)},[C,w]);const x=f||B||L;o.useEffect(()=>{h(p||x)},[p,x,h]);const k=s=>{const a=`sss:${s.sa_id}`,l=d.taskTitles[a];if(l)return l;const t=u(a);return t?r==="ar"?t.label_ar:t.label_en:`Task (SA_ID: ${s.sa_id})`};o.useEffect(()=>{if(f||!i)return;const s=j.current;if(s===void 0){j.current=i;return}const a=new Set(s.map(t=>t.id)),l=new Set(i.map(t=>t.id));for(const t of i)if(!a.has(t.id)){const c=k(t);b({variant:"info",title:d.newTaskTitle,message:`${d.newTaskMessage}
"${c}"`,icon:H})}for(const t of s)if(!l.has(t.id)){const c=k(t);b({variant:"success",title:d.taskCompletedTitle,message:`${d.taskCompletedMessage}
"${c}"`,icon:V})}j.current=i},[i,f,b,d,k]);const Y=s=>{if(s.sequence_number)return`${d.referenceLabel} ${s.sequence_number}`;const a=r==="ar"?s.target_entity_name_ar:s.target_entity_name_en;return`${d.targetLabel} ${a}`};return e.jsx(ee,{mode:"wait",children:e.jsxs(m.div,{custom:r,variants:se,initial:"initial",animate:"animate",exit:"exit",children:[x&&e.jsx(m.div,{variants:P,initial:"initial",animate:"animate",className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl space-y-4 p-4 sm:p-6 border border-gray-700",children:e.jsx("p",{className:"text-center text-gray-400",children:d.loading})}),!x&&(!i||i.length===0)&&e.jsx(he,{hasCompletedTasks:K,translations:d,loading:L}),!x&&i&&i.length>0&&e.jsx(m.div,{variants:P,initial:"initial",animate:"animate",className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl space-y-4 p-4 sm:p-6 border border-gray-700",children:i.map(s=>{const a=k(s),l=Y(s),t=r==="ar"?s.target_entity_name_ar:s.target_entity_name_en,c=C(s),I=s.service_id===5?ae:te;return e.jsx(pe,{task:s,taskTitle:a,reference:l,targetName:t,targetIcon:I,language:r,href:c},s.id)})})]},r)})}export{we as default};
