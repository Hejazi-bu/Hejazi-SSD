import{u as xe,a as ve,b as Se,d as ye,f as je,al as we,r as o,q as C,w as J,h as f,am as _e,an as Ne,k as e,J as Ce,ao as Je,A as Te,m as T,l as Q,ap as De,H as Ie,v as W,aq as Pe,s as Re,ar as Me,N as S}from"./index-AlbxRJrk.js";import{u as $e}from"./useAccessManager-rkPHho6Y.js";import{S as Ee}from"./DelegationTree-DqSkF5PP.js";import{S as Le}from"./ScopeConfigDialog-ByC8QL7E.js";import{F as Fe}from"./AdjustmentsHorizontalIcon-DPQskVqU.js";import"./ChevronDownIcon-BtYLWBft.js";import"./ChevronRightIcon-CG6pqeHi.js";import"./CogIcon-Cm0Oc8sb.js";import"./PencilIcon-DZheH_sc.js";const x=_e(),ke={ar:{pageTitle:"نظام تفويض التحكم (موارد الوظائف)",pageDesc:"تحديد الخدمات التي تملك هذه الوظيفة حق 'التحكم' فيها (أي القدرة على منحها للآخرين).",selectJobTitle:"اختر الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ صلاحيات التحكم",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد التحكم للوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",configureScope:"تخصيص النطاق",scopeGlobal:"عام (الكل)",companyLabel:"الشركة",sectionLabel:"القسم",distributionNotice:"تظهر هنا فقط الشركات والأقسام التي تم توزيع هذه الوظيفة عليها.",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل البيانات من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (Job Resources)",pageDesc:"Define services this job can 'Control' (delegate to others).",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Control Resources",saving:"Saving...",successTitle:"Success",successMessage:"Job control resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",configureScope:"Configure Scope",scopeGlobal:"Global (All)",companyLabel:"Company",sectionLabel:"Section",distributionNotice:"Only companies/sections where this job is distributed appear here.",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},Ae=({job:b,onClick:i,language:_})=>e.jsx(T.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:i,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors border border-gray-600",children:e.jsx(W,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:_==="ar"?b.name_ar:b.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",b.id]})]})]})});function Xe(){const{language:b}=xe(),i=ke[b],{canManageScope:_,canGrantResource:D}=ve(),{updateJobControlResources:I}=$e(),{showDialog:P}=Se(),{showActionLoading:K,hideActionLoading:X}=ye(),{setIsDirty:y}=je(),[Oe,k]=we(),[Y,Z]=o.useState([]),[A,ee]=o.useState([]),[se,R]=o.useState([]),[te,M]=o.useState([]),[p,O]=o.useState(null),[q,ae]=o.useState(null),[$,re]=o.useState(""),[N,oe]=o.useState(""),[g,j]=o.useState(new Map),[v,z]=o.useState(new Map),[ie,E]=o.useState(!1),[w,G]=o.useState(null),[ce,V]=o.useState(!0);o.useEffect(()=>{(async()=>{V(!0);try{const t=(await S(f(x,"jobs"))).docs.map(r=>({id:r.id,...r.data()}));Z(t.filter(r=>_("control",{jobId:r.id})));const[a,d,n]=await Promise.all([S(f(x,"services")),S(f(x,"sub_services")),S(f(x,"sub_sub_services"))]),l=b==="ar"?"label_ar":"label_en",u=a.docs.map(r=>({...r.data(),id:r.data().id??r.id})),L=d.docs.map(r=>({...r.data(),id:r.data().id??r.id})),be=n.docs.map(r=>({...r.data(),id:r.data().id??r.id})),he=u.map(r=>{const F=L.filter(m=>String(m.service_id)===String(r.id)).map(m=>({id:`ss:${m.id}`,label:m[l],parentId:`s:${r.id}`,type:"page",children:[]})),fe=be.filter(m=>String(m.service_id)===String(r.id)).map(m=>({id:`sss:${m.id}`,label:m[l],parentId:`s:${r.id}`,type:"action",children:[]}));return{id:`s:${r.id}`,label:r[l],type:"service",children:[...F,...fe].sort((m,qe)=>m.type==="page"?-1:1)}}).sort((r,F)=>r.id.toString().localeCompare(F.id.toString(),void 0,{numeric:!0}));ee(he)}catch(c){console.error(c)}finally{V(!1)}})()},[b,_]),o.useEffect(()=>{if(!p){R([]),M([]);return}(async()=>{try{const c=C(f(x,"job_distribution"),J("job_id","==",String(p))),t=await S(c),a=new Set,d=new Set;if(t.forEach(n=>{const l=n.data();l.company_id&&a.add(l.company_id),l.section_id&&d.add(l.section_id)}),a.size>0){const l=(await S(C(f(x,"companies"),J("is_allowed","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>a.has(u.id));R(l)}else R([]);if(d.size>0){const l=(await S(C(f(x,"sections"),J("is_active","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>d.has(u.id));M(l)}else M([])}catch(c){console.error("Error fetching job distribution:",c)}})()},[p]);const h=o.useMemo(()=>{if(g.size!==v.size)return!0;for(const[s,c]of g){const t=v.get(s);if(!t||JSON.stringify(c.scope)!==JSON.stringify(t.scope))return!0}return!1},[g,v]);o.useEffect(()=>y(h),[h,y]);const H=o.useRef(h);o.useEffect(()=>{H.current=h},[h]),o.useEffect(()=>{if(!p)return;const s=C(f(x,"control_job_resources"),J("job_id","==",p)),c=Ne(s,t=>{if(t.metadata.hasPendingWrites)return;const a=new Map;t.forEach(d=>{const n=d.data(),l=n.sub_sub_service_id?`sss:${n.sub_sub_service_id}`:n.sub_service_id?`ss:${n.sub_service_id}`:`s:${n.service_id}`,u=n.scope||{};a.set(l,{docId:d.id,scope:{scope_company_id:u.companies?.[0]||null,scope_section_id:u.sections?.[0]||null}})}),H.current?(j(a),z(new Map(a))):(j(a),z(new Map(a)),y(!1))});return()=>c()},[p,y]);const ne=s=>{O(s.id),ae(s),k({jobId:s.id})},le=o.useCallback(s=>g.has(s)?!0:void 0,[g]),de=o.useCallback(s=>v.has(s)?!0:void 0,[v]),ue=o.useCallback((s,c)=>{j(c===!0?t=>new Map(t).set(s,{docId:null,scope:{scope_company_id:null,scope_section_id:null}}):t=>{const a=new Map(t);return a.delete(s),a})},[]),pe=s=>{w&&(j(c=>{const t=new Map(c),a=t.get(w)||{docId:null};return t.set(w,{...a,scope:s}),t}),E(!1),G(null))},ge=async()=>{if(!(!p||!h)){K(i.saving);try{const s=[];v.forEach((t,a)=>{!g.has(a)&&t.docId&&s.push(I(p,{},"remove",t.docId))});const c=[];g.forEach((t,a)=>{const d=v.get(a);if(!d||JSON.stringify(d.scope)!==JSON.stringify(t.scope)){const[n,l]=a.split(":"),u={companies:t.scope.scope_company_id?[t.scope.scope_company_id]:[],sections:t.scope.scope_section_id?[t.scope.scope_section_id]:[],departments:[]},L={service_id:n==="s"?l:void 0,sub_service_id:n==="ss"?l:void 0,sub_sub_service_id:n==="sss"?l:void 0,scope:u};t.docId&&s.push(I(p,{},"remove",t.docId)),c.push(I(p,L,"add"))}}),await Promise.all([...s,...c]),P({variant:"success",title:i.successTitle,message:i.successMessage})}catch(s){P({variant:"alert",title:i.errorTitle,message:s.message||i.errorMessage})}finally{X()}}},U=Y.filter(s=>s.name_ar?.includes($)||s.name_en?.includes($)),me=o.useCallback(s=>{if(!g.has(s.id))return null;const a=g.get(s.id)?.scope,d=a?.scope_company_id||a?.scope_section_id;return e.jsx("button",{onClick:n=>{n.stopPropagation(),G(s.id),E(!0)},className:`p-1.5 rounded-md hover:bg-gray-700 transition-colors ${d?"text-red-400 bg-red-500/10":"text-gray-600"}`,title:i.configureScope,children:d?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(Je,{className:"w-4 h-4"})})},[g,i]),B=o.useMemo(()=>{const s=c=>c.reduce((t,a)=>{if(!D(a.id))return t;const d=s(a.children);return(a.label.toLowerCase().includes(N.toLowerCase())||d.length>0)&&t.push({...a,children:d}),t},[]);return s(A)},[A,N,D]);return ce?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:i.loadingData}):e.jsxs("div",{className:"w-full flex flex-col min-h-screen",children:[e.jsx(Le,{isOpen:ie,onClose:()=>E(!1),onSave:pe,validCompanies:se,validSections:te,initialScope:w?g.get(w)?.scope:null,t:i,language:b}),e.jsx(Te,{mode:"wait",children:p?e.jsxs(T.div,{variants:Q,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]",children:e.jsx(W,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:b==="ar"?q?.name_ar:q?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:i.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{O(null),y(!1),k({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(Pe,{className:"w-4 h-4"})," ",i.changeJob]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:i.filterTreePlaceholder,value:N,onChange:s=>oe(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-red-500 text-sm text-white"}),e.jsx(Fe,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(T.div,{variants:Re,initial:"initial",animate:"animate",children:B.length>0?B.map(s=>e.jsx(Ee,{node:s,getState:le,getJobState:()=>!1,getInitialState:de,onToggle:ue,canEdit:D,t:i,searchTerm:N,rowType:"job",renderScopeButton:me},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!h,onClick:()=>P({variant:"confirm",title:i.confirmSave,message:i.confirmSave,onConfirm:ge}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${h?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(Me,{className:"w-6 h-6"})," ",i.save]})})]},"editor"):e.jsx(T.div,{variants:Q,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-red-400",children:[e.jsx(De,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:i.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:i.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:i.searchPlaceholder,value:$,onChange:s=>re(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(Ie,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),U.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:U.map(s=>e.jsx(Ae,{job:s,language:b,onClick:()=>ne(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:i.noJobsFound})})]})},"select")})]})}export{Xe as default};
