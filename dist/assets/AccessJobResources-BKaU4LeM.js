import{u as oe,a as ce,b as ne,d as le,f as de,al as ue,r as i,q as ge,w as be,h as v,am as me,an as he,k as e,A as xe,m as N,l as L,ao as fe,H as pe,v as O,ap as ve,s as ye,ar as je,N as w}from"./index-DjQnKye2.js";import{u as Se}from"./useAccessManager-ByKSRh3L.js";import{S as we}from"./DelegationTree-BM3T4QwY.js";import{F as Ne}from"./AdjustmentsHorizontalIcon-C5lpyWEE.js";import"./ChevronDownIcon-qIRIwReu.js";import"./ChevronRightIcon-B_NjU3cg.js";import"./CogIcon-CQGT2rf7.js";import"./PencilIcon-u-NC4gBe.js";const y=me(),_e={ar:{pageTitle:"نظام تفويض الوصول (موارد الوظائف)",pageDesc:"تحديد الخدمات والموارد التي تملك هذه الوظيفة حق الوصول إليها أو منحها.",selectJobTitle:"اختر الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ الموارد",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد الوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",conflictTitle:"تحديث خارجي",conflictMessage:"قام مستخدم آخر بتعديل الموارد لهذه الوظيفة. هل تريد تحميل البيانات الجديدة (ستفقد تعديلاتك)؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Access Delegation (Job Resources)",pageDesc:"Define services and resources this job can access or delegate.",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Resources",saving:"Saving...",successTitle:"Success",successMessage:"Job resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",conflictTitle:"External Update",conflictMessage:"Another user updated resources for this job. Load new data (lose changes)?",loadNew:"Load New",ignore:"Ignore"}},Te=({job:u,onClick:r,language:j})=>e.jsx(N.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:r,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors border border-gray-600",children:e.jsx(O,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:j==="ar"?u.name_ar:u.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",u.id]})]})]})});function ke(){const{language:u}=oe(),r=_e[u],{canManageScope:j,canGrantResource:_}=ce(),{updateJobAccessResources:M}=Se(),{showDialog:f}=ne(),{showActionLoading:q,hideActionLoading:z}=le(),{setIsDirty:p}=de(),[Je,R]=ue(),[G,H]=i.useState([]),[D,K]=i.useState([]),[m,P]=i.useState(null),[A,U]=i.useState(null),[T,V]=i.useState(""),[S,W]=i.useState(""),[h,J]=i.useState(new Map),[g,I]=i.useState(new Map),[B,E]=i.useState(!0);i.useEffect(()=>{(async()=>{E(!0);try{const o=(await w(v(y,"jobs"))).docs.map(a=>({id:a.id,...a.data()}));H(o.filter(a=>j("control",{jobId:a.id})));const[t,c,n]=await Promise.all([w(v(y,"services")),w(v(y,"sub_services")),w(v(y,"sub_sub_services"))]),x=u==="ar"?"label_ar":"label_en",se=t.docs.map(a=>({...a.data(),id:a.data().id??a.id})),ae=c.docs.map(a=>({...a.data(),id:a.data().id??a.id})),re=n.docs.map(a=>({...a.data(),id:a.data().id??a.id})),te=se.map(a=>{const C=ae.filter(d=>String(d.service_id)===String(a.id)).map(d=>({id:`ss:${d.id}`,label:d[x],parentId:`s:${a.id}`,type:"page",children:[]})),ie=re.filter(d=>String(d.service_id)===String(a.id)).map(d=>({id:`sss:${d.id}`,label:d[x],parentId:`s:${a.id}`,type:"action",children:[]}));return{id:`s:${a.id}`,label:a[x],type:"service",children:[...C,...ie].sort((d,Ce)=>d.type==="page"?-1:1)}}).sort((a,C)=>a.id.toString().localeCompare(C.id.toString(),void 0,{numeric:!0}));K(te)}catch(l){console.error(l)}finally{E(!1)}})()},[u,j]);const b=i.useMemo(()=>{if(h.size!==g.size)return!0;for(const s of h.keys())if(!g.has(s))return!0;return!1},[h,g]);i.useEffect(()=>p(b),[b,p]);const $=i.useRef(b);i.useEffect(()=>{$.current=b},[b]),i.useEffect(()=>{if(!m)return;const s=ge(v(y,"access_job_resources"),be("job_id","==",m)),l=he(s,o=>{if(o.metadata.hasPendingWrites)return;const t=new Map;if(o.forEach(c=>{const n=c.data(),x=n.sub_sub_service_id?`sss:${n.sub_sub_service_id}`:n.sub_service_id?`ss:${n.sub_service_id}`:`s:${n.service_id}`;t.set(x,c.id)}),$.current){const c=JSON.stringify(Array.from(g.keys()).sort()),n=JSON.stringify(Array.from(t.keys()).sort());c!==n&&f({variant:"alert",title:r.conflictTitle,message:r.conflictMessage,confirmText:r.loadNew,cancelText:r.ignore,onConfirm:()=>{J(t),I(new Map(t))}})}else J(t),I(new Map(t)),p(!1)});return()=>l()},[m,p,r,g,f]);const Q=s=>{P(s.id),U(s),R({jobId:s.id})},X=i.useCallback(s=>h.has(s)?!0:void 0,[h]),Y=i.useCallback(s=>g.has(s)?!0:void 0,[g]),Z=i.useCallback((s,l)=>{J(o=>{const t=new Map(o);return l===!0?t.set(s,"PENDING"):t.delete(s),t})},[]),ee=async()=>{if(!(!m||!b)){q(r.saving);try{const s=[];g.forEach((o,t)=>{h.has(t)||s.push(M(m,{},"remove",o))});const l=[];h.forEach((o,t)=>{if(!g.has(t)){const[c,n]=t.split(":"),x={service_id:c==="s"?n:void 0,sub_service_id:c==="ss"?n:void 0,sub_sub_service_id:c==="sss"?n:void 0};l.push(M(m,x,"add"))}}),await Promise.all([...s,...l]),f({variant:"success",title:r.successTitle,message:r.successMessage})}catch(s){f({variant:"alert",title:r.errorTitle,message:s.message||r.errorMessage})}finally{z()}}},k=G.filter(s=>s.name_ar?.includes(T)||s.name_en?.includes(T)),F=i.useMemo(()=>{const s=l=>l.reduce((o,t)=>{if(!_(t.id))return o;const c=s(t.children);return(t.label.toLowerCase().includes(S.toLowerCase())||c.length>0)&&o.push({...t,children:c}),o},[]);return s(D)},[D,S,_]);return B?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:r.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(xe,{mode:"wait",children:m?e.jsxs(N.div,{variants:L,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]",children:e.jsx(O,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:u==="ar"?A?.name_ar:A?.name_en}),e.jsx("p",{className:"text-xs text-blue-400 font-medium",children:r.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{P(null),p(!1),R({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"})," ",r.changeJob]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:r.filterTreePlaceholder,value:S,onChange:s=>W(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(Ne,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(N.div,{variants:ye,initial:"initial",animate:"animate",children:F.length>0?F.map(s=>e.jsx(we,{node:s,getState:X,getJobState:()=>!1,getInitialState:Y,onToggle:Z,canEdit:_,t:r,searchTerm:S,rowType:"job"},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!b,onClick:()=>f({variant:"confirm",title:r.confirmSave,message:r.confirmSave,onConfirm:ee}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${b?"bg-blue-500 text-white hover:scale-105 hover:bg-blue-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(je,{className:"w-6 h-6"})," ",r.save]})})]},"editor"):e.jsx(N.div,{variants:L,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-blue-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:r.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:r.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:r.searchPlaceholder,value:T,onChange:s=>V(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(pe,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),k.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:k.map(s=>e.jsx(Te,{job:s,language:u,onClick:()=>Q(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:r.noJobsFound})})]})},"select")})})}export{ke as default};
