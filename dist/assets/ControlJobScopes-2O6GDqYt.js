import{u as ae,a as te,b as re,d as oe,f as ne,al as ce,r,q as O,w as $,h as x,am as ie,an as le,k as e,A as de,m as w,l as k,ao as me,H as ge,v as q,ap as ue,ar as xe,N as v}from"./index-DjQnKye2.js";import{u as he}from"./useAccessManager-ByKSRh3L.js";import{S as fe}from"./ScopeRuleBuilder-4RV707eC.js";import{S as pe}from"./ScopeList-B0c6YktL.js";import{F as be}from"./FunnelIcon-D6Ykaui4.js";import"./PlusIcon-VqZkTY5V.js";import"./UserGroupIcon-1ZI4lWI9.js";import"./TrashIcon-CBwyCsvA.js";const h=ie(),ve={ar:{pageTitle:"نظام تفويض التحكم (نطاق الوظائف)",pageDesc:"تحديد النطاقات (الشركات/الإدارات) التي تملك هذه الوظيفة حق 'التحكم' فيها.",selectJobTitle:"اختر الوظيفة المانحة",searchPlaceholder:"ابحث عن وظيفة...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ التغييرات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث نطاق التحكم للوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ قواعد النطاق؟",changeJob:"تغيير الوظيفة",loadingData:"جاري تحميل بيانات الهيكل التنظيمي...",currentRules:"قواعد نطاق التحكم الحالية",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل القواعد من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (Job Scopes)",pageDesc:"Define scopes (Companies/Departments) this job has 'Control' authority over.",selectJobTitle:"Select Granting Job",searchPlaceholder:"Search job...",noJobsFound:"No jobs found.",save:"Save Changes",saving:"Saving...",successTitle:"Success",successMessage:"Job control scope updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save scope rules?",changeJob:"Change Job",loadingData:"Loading organizational structure...",currentRules:"Current Control Scopes",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},ye=({job:l,onClick:s,language:y})=>e.jsx(w.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors border border-gray-600",children:e.jsx(q,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:y==="ar"?l.name_ar:l.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",l.id]})]})]})});function _e(){const{language:l}=ae(),s=ve[l],{canManageScope:y}=te(),{updateJobControlScope:J}=he(),{showDialog:d}=re(),{showActionLoading:H,hideActionLoading:U}=oe(),{setIsDirty:f}=ne(),[je,T]=ce(),[N,z]=r.useState([]),[R,B]=r.useState([]),[D,G]=r.useState([]),[C,V]=r.useState([]),[I,W]=r.useState([]),[m,_]=r.useState(null),[M,K]=r.useState(null),[S,Q]=r.useState(""),[p,P]=r.useState([]),[b,j]=r.useState([]),[X,E]=r.useState(!0);r.useEffect(()=>{(async()=>{E(!0);try{const[n,g,c,o,u]=await Promise.all([v(x(h,"jobs")),v(O(x(h,"companies"),$("is_allowed","==",!0))),v(x(h,"sectors")),v(x(h,"departments")),v(x(h,"sections"))]),A=n.docs.map(t=>({id:t.id,...t.data()}));z(A.filter(t=>y("control",{jobId:t.id}))),B(g.docs.map(t=>({id:t.id,...t.data()}))),G(c.docs.map(t=>({id:t.id,...t.data()}))),V(o.docs.map(t=>({id:t.id,...t.data()}))),W(u.docs.map(t=>({id:t.id,...t.data()})))}catch(n){console.error("Error fetching structure data:",n),d({title:s.errorTitle,message:"فشل تحميل بيانات الهيكل التنظيمي",variant:"error"})}finally{E(!1)}})()},[y,s.errorTitle,d]);const i=r.useMemo(()=>JSON.stringify(b)!==JSON.stringify(p),[b,p]);r.useEffect(()=>f(i),[i,f]);const F=r.useRef(i);r.useEffect(()=>{F.current=i},[i]),r.useEffect(()=>{if(!m)return;const a=O(x(h,"control_job_scopes"),$("job_id","==",m)),n=le(a,g=>{if(g.metadata.hasPendingWrites)return;const c=g.docs.map(o=>({docId:o.id,...o.data()}));if(F.current){const o=JSON.stringify(c),u=JSON.stringify(p);o!==u&&d({variant:"alert",title:s.conflictTitle,message:s.conflictMessage,confirmText:s.loadNew,cancelText:s.ignore,onConfirm:()=>{P(c),j(c)}})}else P(c),j(c),f(!1)});return()=>n()},[m,f,s,p,d]);const Y=a=>{_(a.id),K(a),T({jobId:a.id})},Z=a=>{j(n=>[...n,{...a,isNew:!0}])},ee=a=>{j(n=>n.filter((g,c)=>c!==a))},se=async()=>{if(!(!m||!i)){H(s.saving);try{const a=p.filter(o=>!b.some(u=>u.docId===o.docId)),n=b.filter(o=>!o.docId),g=a.map(o=>J(m,{},"remove",o.docId)),c=n.map(o=>{const{isNew:u,docId:A,...t}=o;return J(m,t,"add")});await Promise.all([...g,...c]),d({variant:"success",title:s.successTitle,message:s.successMessage})}catch(a){d({variant:"alert",title:s.errorTitle,message:a.message||s.errorMessage})}finally{U()}}},L=N.filter(a=>a.name_ar?.includes(S)||a.name_en?.includes(S));return X?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(de,{mode:"wait",children:m?e.jsxs(w.div,{variants:k,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]",children:e.jsx(q,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:l==="ar"?M?.name_ar:M?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{_(null),f(!1),T({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"})," ",s.changeJob]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsx(fe,{jobs:N,companies:R,sectors:D,departments:C,sections:I,onAddRule:Z,t:s}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(be,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(pe,{rules:b,onRemove:ee,jobs:N,companies:R,sectors:D,departments:C,sections:I,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!i,onClick:()=>d({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:se}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${i?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(xe,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(w.div,{variants:k,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-red-400",children:[e.jsx(me,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:S,onChange:a=>Q(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(ge,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),L.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:L.map(a=>e.jsx(ye,{job:a,language:l,onClick:()=>Y(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noJobsFound})})]})},"select")})})}export{_e as default};
