import{u as be,a as he,b as fe,d as xe,f as ve,al as Se,r,q as J,w as T,h as f,am as ye,an as we,k as e,J as _e,ao as je,A as Ne,m as P,l as H,ap as Je,H as Te,v as B,aq as Pe,s as Ce,ar as Me,N as v}from"./index-AlbxRJrk.js";import{u as Ee}from"./useAccessManager-rkPHho6Y.js";import{S as Re}from"./DelegationTree-DqSkF5PP.js";import{S as $e}from"./ScopeConfigDialog-ByC8QL7E.js";import{F as Fe}from"./AdjustmentsHorizontalIcon-DPQskVqU.js";import"./ChevronDownIcon-BtYLWBft.js";import"./ChevronRightIcon-CG6pqeHi.js";import"./CogIcon-Cm0Oc8sb.js";import"./PencilIcon-DZheH_sc.js";const x=ye(),Ie={ar:{pageTitle:"إدارة صلاحيات الوظائف",selectJobTitle:"اختيار الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لم يتم العثور على وظائف.",save:"حفظ الصلاحيات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث صلاحيات الوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",scopeGlobal:"عام (الكل)",scopeRestricted:"مقيد بنطاق محدد",configureScope:"تخصيص النطاق",conflictTitle:"تحديث خارجي",conflictMessage:"بيانات خارجية تغيرت. هل تريد التحديث؟",loadNew:"تحميل",ignore:"تجاهل",cancel:"إلغاء",companyLabel:"الشركة",sectionLabel:"القسم",distributionNotice:"تظهر هنا فقط الشركات والأقسام التي تم توزيع هذه الوظيفة عليها."},en:{pageTitle:"Manage Job Permissions",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Permissions",saving:"Saving...",successTitle:"Success",successMessage:"Job permissions updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",scopeGlobal:"Global (All)",scopeRestricted:"Restricted Scope",configureScope:"Configure Scope",conflictTitle:"External Update",conflictMessage:"External data changed. Update?",loadNew:"Load",ignore:"Ignore",cancel:"Cancel",companyLabel:"Company",sectionLabel:"Section",distributionNotice:"Only companies/sections where this job is distributed appear here."}},Ae=({job:g,onClick:c,language:_})=>e.jsx(P.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:c,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors border border-gray-600",children:e.jsx(B,{className:"w-6 h-6"})}),e.jsx("div",{children:e.jsx("h3",{className:"font-bold text-gray-100",children:_==="ar"?g.name_ar:g.name_en})})]})});function Qe(){const{language:g}=be(),c=Ie[g],{canManageScope:_,canGrantResource:C}=he(),{updateJobPermissions:Q}=Ee(),{showDialog:M}=fe(),{showActionLoading:W,hideActionLoading:K}=xe(),{setIsDirty:S}=ve(),[De,k]=Se(),[X,Y]=r.useState([]),[L,Z]=r.useState([]),[ee,E]=r.useState([]),[se,R]=r.useState([]),[b,O]=r.useState(null),[q,ae]=r.useState(null),[$,te]=r.useState(""),[j,z]=r.useState(""),[p,y]=r.useState(new Map),[w,F]=r.useState(new Map),[ie,I]=r.useState(!1),[N,G]=r.useState(null);r.useEffect(()=>{(async()=>{try{const[o,a,t,l]=await Promise.all([v(f(x,"jobs")),v(f(x,"services")),v(f(x,"sub_services")),v(f(x,"sub_sub_services"))]),n=o.docs.map(i=>({id:i.id,...i.data()}));Y(n.filter(i=>_("access",{jobId:i.id})));const d=g==="ar"?"label_ar":"label_en",u=a.docs.map(i=>({...i.data(),id:i.data().id??i.id})),A=t.docs.map(i=>({...i.data(),id:i.data().id??i.id})),pe=l.docs.map(i=>({...i.data(),id:i.data().id??i.id})),me=u.map(i=>{const D=A.filter(m=>String(m.service_id)===String(i.id)).map(m=>({id:`ss:${m.id}`,label:m[d],parentId:`s:${i.id}`,type:"page",children:[]})),ge=pe.filter(m=>String(m.service_id)===String(i.id)).map(m=>({id:`sss:${m.id}`,label:m[d],parentId:`s:${i.id}`,type:"action",children:[]}));return{id:`s:${i.id}`,label:i[d],type:"service",children:[...D,...ge].sort((m,ke)=>m.type==="page"?-1:1)}}).sort((i,D)=>i.id.toString().localeCompare(D.id.toString(),void 0,{numeric:!0}));Z(me)}catch(o){console.error(o)}})()},[g,_]),r.useEffect(()=>{if(!b){E([]),R([]);return}(async()=>{try{const o=J(f(x,"job_distribution"),T("job_id","==",String(b))),a=await v(o),t=new Set,l=new Set;if(a.forEach(n=>{const d=n.data();d.company_id&&t.add(d.company_id),d.section_id&&l.add(d.section_id)}),t.size>0){const d=(await v(J(f(x,"companies"),T("is_allowed","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>t.has(u.id));E(d)}else E([]);if(l.size>0){const d=(await v(J(f(x,"sections"),T("is_active","==",!0)))).docs.map(u=>({id:u.id,...u.data()})).filter(u=>l.has(u.id));R(d)}else R([])}catch(o){console.error("Error fetching job distribution:",o)}})()},[b]);const h=r.useMemo(()=>{if(p.size!==w.size)return!0;for(const[s,o]of p){const a=w.get(s);if(!a||JSON.stringify(o)!==JSON.stringify(a))return!0}return!1},[p,w]);r.useEffect(()=>S(h),[h,S]);const V=r.useRef(h);r.useEffect(()=>{V.current=h},[h]),r.useEffect(()=>{if(!b)return;const s=J(f(x,"job_permissions"),T("job_id","==",String(b))),o=we(s,a=>{if(a.metadata.hasPendingWrites)return;const t=new Map;a.forEach(l=>{const n=l.data(),d=n.sub_sub_service_id?`sss:${n.sub_sub_service_id}`:n.sub_service_id?`ss:${n.sub_service_id}`:`s:${n.service_id}`,u=n.scope_companies&&n.scope_companies.length>0?n.scope_companies[0]:n.scope_company_id||null,A=n.scope_sections&&n.scope_sections.length>0?n.scope_sections[0]:n.scope_section_id||null;t.set(d,{scope_company_id:u,scope_section_id:A})}),V.current?(y(t),F(new Map(t))):(y(t),F(new Map(t)))});return()=>o()},[b]);const re=s=>{O(s.id),ae(s),z(""),S(!1),k({jobId:s.id})},oe=r.useCallback(s=>p.has(s),[p]),ne=r.useCallback((s,o)=>{y(o===!0?a=>new Map(a).set(s,{scope_company_id:null,scope_section_id:null}):a=>{const t=new Map(a);return t.delete(s),t})},[]),ce=s=>{N&&(y(o=>new Map(o).set(N,s)),I(!1),G(null))},le=async()=>{if(!b||!h)return;const s=[],o=[];p.forEach((a,t)=>{const l=w.get(t);if(!l||JSON.stringify(l)!==JSON.stringify(a)){const n={companies:a.scope_company_id?[a.scope_company_id]:[],sections:a.scope_section_id?[a.scope_section_id]:[],departments:[]};s.push({id:t,is_allowed:!0,scope:n})}}),w.forEach((a,t)=>{p.has(t)||o.push(t)}),W(c.saving);try{await Q(b,s,o),F(new Map(p)),S(!1),M({variant:"success",title:c.successTitle,message:c.successMessage})}catch(a){M({variant:"alert",title:c.errorTitle,message:a.message||c.errorMessage})}finally{K()}},U=X.filter(s=>s.name_ar?.includes($)||s.name_en?.includes($)),de=r.useCallback(s=>{if(!p.has(s.id))return null;const a=p.get(s.id),t=a?.scope_company_id||a?.scope_section_id;return e.jsx("button",{onClick:l=>{l.stopPropagation(),G(s.id),I(!0)},className:`p-1.5 rounded-md hover:bg-gray-700 transition-colors ${t?"text-orange-400 bg-orange-500/10":"text-gray-600"}`,title:c.configureScope,children:t?e.jsx(_e,{className:"w-4 h-4"}):e.jsx(je,{className:"w-4 h-4"})})},[p,c]),ue=r.useMemo(()=>{const s=o=>o.reduce((a,t)=>{if(!C(t.id))return a;const l=s(t.children);return(t.label.toLowerCase().includes(j.toLowerCase())||l.length>0)&&a.push({...t,children:l}),a},[]);return s(L)},[L,j,C]);return e.jsxs("div",{className:"w-full flex flex-col min-h-screen",children:[e.jsx($e,{isOpen:ie,onClose:()=>I(!1),onSave:ce,validCompanies:ee,validSections:se,initialScope:N?p.get(N):null,t:c,language:g}),e.jsx(Ne,{mode:"wait",children:b?e.jsxs(P.div,{variants:H,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 space-y-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500",children:e.jsx(B,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:g==="ar"?q?.name_ar:q?.name_en}),e.jsx("p",{className:"text-xs text-gray-400",children:c.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{O(null),S(!1),k({})},className:"text-sm text-blue-400 hover:underline flex items-center gap-1",children:[e.jsx(Pe,{className:"w-4 h-4"})," ",c.changeJob]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:c.filterTreePlaceholder,value:j,onChange:s=>z(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(Fe,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})]}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(P.div,{variants:Ce,initial:"initial",animate:"animate",children:ue.map(s=>e.jsx(Re,{node:s,getState:oe,onToggle:ne,canEdit:C,t:c,searchTerm:j,rowType:"job",renderScopeButton:de},s.id))})}),e.jsx("div",{className:"flex justify-center pb-10 mt-auto",children:e.jsxs("button",{disabled:!h,onClick:()=>M({variant:"confirm",title:c.confirmSave,message:c.confirmSave,onConfirm:le}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${h?"bg-[#FFD700] text-black hover:scale-105":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(Me,{className:"w-6 h-6"})," ",c.save]})})]},"editor"):e.jsx(P.div,{variants:H,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 text-blue-400",children:[e.jsx(Je,{className:"w-6 h-6"}),e.jsx("h2",{className:"text-xl font-bold",children:c.selectJobTitle})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:c.searchPlaceholder,value:$,onChange:s=>te(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(Te,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),U.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:U.map(s=>e.jsx(Ae,{job:s,language:g,onClick:()=>re(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:e.jsx("p",{children:c.noJobsFound})})]})},"select")})]})}export{Qe as default};
