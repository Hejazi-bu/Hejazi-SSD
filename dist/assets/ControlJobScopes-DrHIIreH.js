import{u as ne,a as ie,b as ce,d as le,f as de,al as me,r as t,q as R,w as _,h as f,am as ge,an as ue,k as e,A as xe,m as I,l as z,ap as fe,H as he,v as V,aq as pe,ar as be,N as p}from"./index-AlbxRJrk.js";import{u as ye}from"./useAccessManager-rkPHho6Y.js";import{S as ve,a as je}from"./ScopeList-BVpSby1C.js";import{F as Se}from"./FunnelIcon-C_Cz-zVd.js";import"./TrashIcon-DqVoRP7K.js";import"./UserGroupIcon-Q_vkDVVC.js";const h=ge(),Ne={ar:{pageTitle:"نظام تفويض التحكم (نطاق الوظائف)",pageDesc:"تحديد النطاقات (الشركات/الإدارات) التي تملك هذه الوظيفة حق 'التحكم' فيها.",selectJobTitle:"اختر الوظيفة المانحة",searchPlaceholder:"ابحث عن وظيفة...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ التغييرات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث نطاق التحكم للوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ قواعد النطاق؟",changeJob:"تغيير الوظيفة",loadingData:"جاري تحميل بيانات الهيكل التنظيمي...",currentRules:"قواعد نطاق التحكم الحالية",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل القواعد من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (Job Scopes)",pageDesc:"Define scopes (Companies/Departments) this job has 'Control' authority over.",selectJobTitle:"Select Granting Job",searchPlaceholder:"Search job...",noJobsFound:"No jobs found.",save:"Save Changes",saving:"Saving...",successTitle:"Success",successMessage:"Job control scope updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save scope rules?",changeJob:"Change Job",loadingData:"Loading organizational structure...",currentRules:"Current Control Scopes",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},we=({job:u,onClick:s,language:j})=>e.jsx(I.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors border border-gray-600",children:e.jsx(V,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:j==="ar"?u.name_ar:u.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",u.id]})]})]})});function Me(){const{language:u}=ne(),s=Ne[u],{canManageScope:j}=ie(),{updateJobControlScope:E}=ye(),{showDialog:x}=ce(),{showActionLoading:H,hideActionLoading:U}=le(),{setIsDirty:b}=de(),[Je,M]=me(),[N,B]=t.useState([]),[w,G]=t.useState([]),[P,Q]=t.useState([]),[F,W]=t.useState([]),[J,K]=t.useState([]),[X,C]=t.useState([]),[Y,D]=t.useState([]),[d,L]=t.useState(null),[A,Z]=t.useState(null),[T,ee]=t.useState(""),[y,O]=t.useState([]),[v,S]=t.useState([]),[se,$]=t.useState(!0);t.useEffect(()=>{(async()=>{$(!0);try{const[n,m,i,r,c]=await Promise.all([p(f(h,"jobs")),p(R(f(h,"companies"),_("is_allowed","==",!0))),p(f(h,"sectors")),p(f(h,"departments")),p(f(h,"sections"))]),l=n.docs.map(o=>({id:o.id,...o.data()}));B(l.filter(o=>j("control",{jobId:o.id}))),G(m.docs.map(o=>({id:o.id,...o.data()}))),Q(i.docs.map(o=>({id:o.id,...o.data()}))),W(r.docs.map(o=>({id:o.id,...o.data()}))),K(c.docs.map(o=>({id:o.id,...o.data()})))}catch(n){console.error("Error fetching structure data:",n),x({title:s.errorTitle,message:"فشل تحميل بيانات الهيكل التنظيمي",variant:"error"})}finally{$(!1)}})()},[j,s.errorTitle,x]),t.useEffect(()=>{if(!d){C([]),D([]);return}(async()=>{try{const n=R(f(h,"job_distribution"),_("job_id","==",String(d))),m=await p(n),i=new Set,r=new Set;if(m.forEach(c=>{const l=c.data();l.company_id&&i.add(l.company_id),l.section_id&&r.add(l.section_id)}),i.size>0){const c=w.filter(l=>i.has(l.id));C(c)}else C([]);if(r.size>0){const c=J.filter(l=>r.has(l.id));D(c)}else D([])}catch(n){console.error("Error fetching job distribution:",n)}})()},[d,w,J]);const g=t.useMemo(()=>JSON.stringify(v)!==JSON.stringify(y),[v,y]);t.useEffect(()=>b(g),[g,b]);const k=t.useRef(g);t.useEffect(()=>{k.current=g},[g]),t.useEffect(()=>{if(!d)return;const a=R(f(h,"control_job_scopes"),_("job_id","==",d)),n=ue(a,m=>{if(m.metadata.hasPendingWrites)return;const i=m.docs.map(r=>({docId:r.id,...r.data()}));if(k.current){const r=JSON.stringify(i),c=JSON.stringify(y);r!==c&&x({variant:"alert",title:s.conflictTitle,message:s.conflictMessage,confirmText:s.loadNew,cancelText:s.ignore,onConfirm:()=>{O(i),S(i)}})}else O(i),S(i),b(!1)});return()=>n()},[d,b,s,y,x]);const ae=a=>{L(a.id),Z(a),M({jobId:a.id})},te=a=>{S(n=>[...n,{...a,isNew:!0}])},re=a=>{S(n=>n.filter((m,i)=>i!==a))},oe=async()=>{if(!(!d||!g)){H(s.saving);try{const a=y.filter(r=>!v.some(c=>c.docId===r.docId)),n=v.filter(r=>!r.docId),m=a.map(r=>E(d,{},"remove",r.docId)),i=n.map(r=>{const{isNew:c,docId:l,...o}=r;return E(d,o,"add")});await Promise.all([...m,...i]),x({variant:"success",title:s.successTitle,message:s.successMessage})}catch(a){x({variant:"alert",title:s.errorTitle,message:a.message||s.errorMessage})}finally{U()}}},q=N.filter(a=>a.name_ar?.includes(T)||a.name_en?.includes(T));return se?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(xe,{mode:"wait",children:d?e.jsxs(I.div,{variants:z,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]",children:e.jsx(V,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:u==="ar"?A?.name_ar:A?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{L(null),b(!1),M({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"})," ",s.changeJob]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsx(ve,{jobs:N,companies:X,sectors:P,departments:F,sections:Y,onAddRule:te,t:s}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(je,{rules:v,onRemove:re,jobs:N,companies:w,sectors:P,departments:F,sections:J,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!g,onClick:()=>x({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:oe}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${g?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(be,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(I.div,{variants:z,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-red-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:T,onChange:a=>ee(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(he,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),q.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:q.map(a=>e.jsx(we,{job:a,language:u,onClick:()=>ae(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noJobsFound})})]})},"select")})})}export{Me as default};
