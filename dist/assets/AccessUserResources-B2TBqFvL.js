import{u as le,a as ce,b as ne,d as oe,f as de,al as ue,r as i,q as ge,w as me,h as y,am as he,an as q,k as e,A as xe,m as _,l as O,ap as fe,H as ve,as as G,aq as pe,s as be,ar as ye,N as R}from"./index-AlbxRJrk.js";import{u as we}from"./useAccessManager-rkPHho6Y.js";import{S as je}from"./DelegationTree-DqSkF5PP.js";import{F as Se}from"./AdjustmentsHorizontalIcon-DPQskVqU.js";import"./ChevronDownIcon-BtYLWBft.js";import"./ChevronRightIcon-CG6pqeHi.js";import"./CogIcon-Cm0Oc8sb.js";import"./PencilIcon-DZheH_sc.js";const w=he(),Ne={ar:{pageTitle:"نظام تفويض الوصول (موارد المستخدمين)",pageDesc:"منح مستخدم محدد حق الوصول إلى موارد (خدمات/صفحات) إضافية كاستثناء.",selectUserTitle:"اختر المستخدم",searchPlaceholder:"ابحث عن مستخدم...",filterTreePlaceholder:"بحث داخل الخدمات...",noUsersFound:"لا يوجد مستخدمين متاحين في نطاق تحكمك.",save:"حفظ الاستثناءات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد المستخدم.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeUser:"تغيير المستخدم",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل الموارد لهذا المستخدم من مصدر آخر. هل تريد تحميل البيانات الجديدة؟ (ستفقد تعديلاتك)",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Access Delegation (User Resources)",pageDesc:"Grant a specific user access to extra resources (services/pages) as an exception.",selectUserTitle:"Select User",searchPlaceholder:"Search user...",filterTreePlaceholder:"Search services...",noUsersFound:"No users found in your control scope.",save:"Save Exceptions",saving:"Saving...",successTitle:"Success",successMessage:"User resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeUser:"Change User",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",conflictTitle:"External Update",conflictMessage:"Resources updated externally. Load new data? (You will lose current changes)",loadNew:"Load New",ignore:"Ignore"}},_e=({user:d,onClick:a,language:f})=>e.jsx(_.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:a,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors overflow-hidden border border-gray-600",children:d.avatar_url?e.jsx("img",{src:d.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:f==="ar"?d.name_ar:d.name_en}),e.jsx("p",{className:"text-xs text-gray-500",children:f==="ar"?d.job?.name_ar:d.job?.name_en})]})]})});function $e(){const{language:d}=le(),a=Ne[d],{canManageScope:f,canGrantResource:T}=ce(),{updateUserAccessResources:D}=we(),{showDialog:v}=ne(),{showActionLoading:J,hideActionLoading:z}=oe(),{setIsDirty:p}=de(),[Te,P]=ue(),[H,K]=i.useState([]),[I,V]=i.useState([]),[h,A]=i.useState(null),[j,W]=i.useState(null),[U,Y]=i.useState(""),[S,B]=i.useState(""),[x,C]=i.useState(new Map),[g,E]=i.useState(new Map),[Q,$]=i.useState(!0);i.useEffect(()=>{(async()=>{$(!0);try{const u=q(y(w,"users"),t=>{const M=t.docs.map(l=>({id:l.id,...l.data()})).filter(l=>f("control",{userId:l.id,companyId:l.company_id,jobId:String(l.job_id)}));K(M)}),[n,r,o]=await Promise.all([R(y(w,"services")),R(y(w,"sub_services")),R(y(w,"sub_sub_services"))]),c=d==="ar"?"label_ar":"label_en",b=n.docs.map(t=>({...t.data(),id:t.data().id??t.id})),re=r.docs.map(t=>({...t.data(),id:t.data().id??t.id})),te=o.docs.map(t=>({...t.data(),id:t.data().id??t.id})),ie=b.map(t=>{const N=re.filter(l=>String(l.service_id)===String(t.id)).map(l=>({id:`ss:${l.id}`,label:l[c],parentId:`s:${t.id}`,type:"page",children:[]})),M=te.filter(l=>String(l.service_id)===String(t.id)).map(l=>({id:`sss:${l.id}`,label:l[c],parentId:`s:${t.id}`,type:"action",children:[]}));return{id:`s:${t.id}`,label:t[c],type:"service",children:[...N,...M].sort((l,Ue)=>l.type==="page"?-1:1)}}).sort((t,N)=>t.id.toString().localeCompare(N.id.toString(),void 0,{numeric:!0}));return V(ie),()=>u()}catch(u){console.error(u)}finally{$(!1)}})()},[d,f]);const m=i.useMemo(()=>{if(x.size!==g.size)return!0;for(const s of x.keys())if(!g.has(s))return!0;return!1},[x,g]);i.useEffect(()=>p(m),[m,p]);const k=i.useRef(m);i.useEffect(()=>{k.current=m},[m]),i.useEffect(()=>{if(!h)return;const s=ge(y(w,"access_user_resources"),me("user_id","==",h)),u=q(s,n=>{if(n.metadata.hasPendingWrites)return;const r=new Map;if(n.forEach(o=>{const c=o.data(),b=c.sub_sub_service_id?`sss:${c.sub_sub_service_id}`:c.sub_service_id?`ss:${c.sub_service_id}`:`s:${c.service_id}`;r.set(b,o.id)}),k.current){const o=JSON.stringify(Array.from(g.keys()).sort()),c=JSON.stringify(Array.from(r.keys()).sort());o!==c&&v({variant:"alert",title:a.conflictTitle,message:a.conflictMessage,confirmText:a.loadNew,cancelText:a.ignore,onConfirm:()=>{C(r),E(new Map(r))}})}else C(r),E(new Map(r)),p(!1)});return()=>u()},[h,p,a,g,v]);const X=s=>{A(s.id),W(s),P({userId:s.id})},Z=i.useCallback(s=>x.has(s)?!0:void 0,[x]),ee=i.useCallback(s=>g.has(s)?!0:void 0,[g]),se=i.useCallback((s,u)=>{C(n=>{const r=new Map(n);return u===!0?r.set(s,"PENDING"):r.delete(s),r})},[]),ae=async()=>{if(!(!h||!m)){J(a.saving);try{const s=[];g.forEach((n,r)=>{x.has(r)||s.push(D(h,{},"remove",n))});const u=[];x.forEach((n,r)=>{if(!g.has(r)){const[o,c]=r.split(":"),b={service_id:o==="s"?c:void 0,sub_service_id:o==="ss"?c:void 0,sub_sub_service_id:o==="sss"?c:void 0};u.push(D(h,b,"add"))}}),await Promise.all([...s,...u]),v({variant:"success",title:a.successTitle,message:a.successMessage})}catch(s){v({variant:"alert",title:a.errorTitle,message:s.message||a.errorMessage})}finally{z()}}},F=H.filter(s=>s.name_ar?.includes(U)||s.name_en?.includes(U)),L=i.useMemo(()=>{const s=u=>u.reduce((n,r)=>{if(!T(r.id))return n;const o=s(r.children);return(r.label.toLowerCase().includes(S.toLowerCase())||o.length>0)&&n.push({...r,children:o}),n},[]);return s(I)},[I,S,T]);return Q?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:a.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(xe,{mode:"wait",children:h?e.jsxs(_.div,{variants:O,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)] overflow-hidden",children:j?.avatar_url?e.jsx("img",{src:j.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(G,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:d==="ar"?j?.name_ar:j?.name_en}),e.jsx("p",{className:"text-xs text-blue-400 font-medium",children:a.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{A(null),p(!1),P({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"})," ",a.changeUser]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:a.filterTreePlaceholder,value:S,onChange:s=>B(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(Se,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(_.div,{variants:be,initial:"initial",animate:"animate",children:L.length>0?L.map(s=>e.jsx(je,{node:s,getState:Z,getJobState:()=>!1,getInitialState:ee,onToggle:se,canEdit:T,t:a,searchTerm:S,rowType:"job"},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!m,onClick:()=>v({variant:"confirm",title:a.confirmSave,message:a.confirmSave,onConfirm:ae}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${m?"bg-blue-500 text-white hover:scale-105 hover:bg-blue-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(ye,{className:"w-6 h-6"})," ",a.save]})})]},"editor"):e.jsx(_.div,{variants:O,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-blue-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:a.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:a.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:a.searchPlaceholder,value:U,onChange:s=>Y(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(ve,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),F.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:F.map(s=>e.jsx(_e,{user:s,language:d,onClick:()=>X(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:a.noUsersFound})})]})},"select")})})}export{$e as default};
