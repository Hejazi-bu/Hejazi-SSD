import{u as oe,a as ne,b as le,d as ce,f as de,al as ge,r as i,q as ue,w as me,h as v,am as he,an as be,k as e,A as xe,m as N,l as L,ao as fe,H as pe,v as O,ap as ve,s as ye,ar as je,N as w}from"./index-DjQnKye2.js";import{u as Se}from"./useAccessManager-ByKSRh3L.js";import{S as we}from"./DelegationTree-BM3T4QwY.js";import{F as Ne}from"./AdjustmentsHorizontalIcon-C5lpyWEE.js";import"./ChevronDownIcon-qIRIwReu.js";import"./ChevronRightIcon-B_NjU3cg.js";import"./CogIcon-CQGT2rf7.js";import"./PencilIcon-u-NC4gBe.js";const y=he(),_e={ar:{pageTitle:"نظام تفويض التحكم (موارد الوظائف)",pageDesc:"تحديد الخدمات التي تملك هذه الوظيفة حق 'التحكم' فيها (أي القدرة على منحها للآخرين).",selectJobTitle:"اختر الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لا توجد وظائف متاحة.",save:"حفظ صلاحيات التحكم",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث موارد التحكم للوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",loadingData:"جاري تحميل البيانات...",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل البيانات من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Control Delegation (Job Resources)",pageDesc:"Define services this job can 'Control' (delegate to others).",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Control Resources",saving:"Saving...",successTitle:"Success",successMessage:"Job control resources updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",loadingData:"Loading data...",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},Te=({job:g,onClick:r,language:j})=>e.jsx(N.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:r,className:"bg-gray-800/50 border border-gray-700 hover:border-red-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-red-400 transition-colors border border-gray-600",children:e.jsx(O,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:j==="ar"?g.name_ar:g.name_en}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID: ",g.id]})]})]})});function Ae(){const{language:g}=oe(),r=_e[g],{canManageScope:j,canGrantResource:_}=ne(),{updateJobControlResources:D}=Se(),{showDialog:f}=le(),{showActionLoading:q,hideActionLoading:z}=ce(),{setIsDirty:p}=de(),[Je,M]=ge(),[G,H]=i.useState([]),[R,K]=i.useState([]),[h,P]=i.useState(null),[I,U]=i.useState(null),[T,V]=i.useState(""),[S,W]=i.useState(""),[b,J]=i.useState(new Map),[u,E]=i.useState(new Map),[B,$]=i.useState(!0);i.useEffect(()=>{(async()=>{$(!0);try{const o=(await w(v(y,"jobs"))).docs.map(a=>({id:a.id,...a.data()}));H(o.filter(a=>j("control",{jobId:a.id})));const[t,n,l]=await Promise.all([w(v(y,"services")),w(v(y,"sub_services")),w(v(y,"sub_sub_services"))]),x=g==="ar"?"label_ar":"label_en",se=t.docs.map(a=>({...a.data(),id:a.data().id??a.id})),ae=n.docs.map(a=>({...a.data(),id:a.data().id??a.id})),re=l.docs.map(a=>({...a.data(),id:a.data().id??a.id})),te=se.map(a=>{const C=ae.filter(d=>String(d.service_id)===String(a.id)).map(d=>({id:`ss:${d.id}`,label:d[x],parentId:`s:${a.id}`,type:"page",children:[]})),ie=re.filter(d=>String(d.service_id)===String(a.id)).map(d=>({id:`sss:${d.id}`,label:d[x],parentId:`s:${a.id}`,type:"action",children:[]}));return{id:`s:${a.id}`,label:a[x],type:"service",children:[...C,...ie].sort((d,Ce)=>d.type==="page"?-1:1)}}).sort((a,C)=>a.id.toString().localeCompare(C.id.toString(),void 0,{numeric:!0}));K(te)}catch(c){console.error(c)}finally{$(!1)}})()},[g,j]);const m=i.useMemo(()=>{if(b.size!==u.size)return!0;for(const s of b.keys())if(!u.has(s))return!0;return!1},[b,u]);i.useEffect(()=>p(m),[m,p]);const k=i.useRef(m);i.useEffect(()=>{k.current=m},[m]),i.useEffect(()=>{if(!h)return;const s=ue(v(y,"control_job_resources"),me("job_id","==",h)),c=be(s,o=>{if(o.metadata.hasPendingWrites)return;const t=new Map;if(o.forEach(n=>{const l=n.data(),x=l.sub_sub_service_id?`sss:${l.sub_sub_service_id}`:l.sub_service_id?`ss:${l.sub_service_id}`:`s:${l.service_id}`;t.set(x,n.id)}),k.current){const n=JSON.stringify(Array.from(u.keys()).sort()),l=JSON.stringify(Array.from(t.keys()).sort());n!==l&&f({variant:"alert",title:r.conflictTitle,message:r.conflictMessage,confirmText:r.loadNew,cancelText:r.ignore,onConfirm:()=>{J(t),E(new Map(t))}})}else J(t),E(new Map(t)),p(!1)});return()=>c()},[h,p,r,u,f]);const Q=s=>{P(s.id),U(s),M({jobId:s.id})},X=i.useCallback(s=>b.has(s)?!0:void 0,[b]),Y=i.useCallback(s=>u.has(s)?!0:void 0,[u]),Z=i.useCallback((s,c)=>{J(o=>{const t=new Map(o);return c===!0?t.set(s,"PENDING"):t.delete(s),t})},[]),ee=async()=>{if(!(!h||!m)){q(r.saving);try{const s=[];u.forEach((o,t)=>{b.has(t)||s.push(D(h,{},"remove",o))});const c=[];b.forEach((o,t)=>{if(!u.has(t)){const[n,l]=t.split(":"),x={service_id:n==="s"?l:void 0,sub_service_id:n==="ss"?l:void 0,sub_sub_service_id:n==="sss"?l:void 0};c.push(D(h,x,"add"))}}),await Promise.all([...s,...c]),f({variant:"success",title:r.successTitle,message:r.successMessage})}catch(s){f({variant:"alert",title:r.errorTitle,message:s.message||r.errorMessage})}finally{z()}}},A=G.filter(s=>s.name_ar?.includes(T)||s.name_en?.includes(T)),F=i.useMemo(()=>{const s=c=>c.reduce((o,t)=>{if(!_(t.id))return o;const n=s(t.children);return(t.label.toLowerCase().includes(S.toLowerCase())||n.length>0)&&o.push({...t,children:n}),o},[]);return s(R)},[R,S,_]);return B?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:r.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(xe,{mode:"wait",children:h?e.jsxs(N.div,{variants:L,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]",children:e.jsx(O,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:g==="ar"?I?.name_ar:I?.name_en}),e.jsx("p",{className:"text-xs text-red-400 font-medium",children:r.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{P(null),p(!1),M({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"})," ",r.changeJob]})]}),e.jsx("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:r.filterTreePlaceholder,value:S,onChange:s=>W(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-red-500 text-sm text-white"}),e.jsx(Ne,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(N.div,{variants:ye,initial:"initial",animate:"animate",children:F.length>0?F.map(s=>e.jsx(we,{node:s,getState:X,getJobState:()=>!1,getInitialState:Y,onToggle:Z,canEdit:_,t:r,searchTerm:S,rowType:"job"},s.id)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"لا توجد نتائج"})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!m,onClick:()=>f({variant:"confirm",title:r.confirmSave,message:r.confirmSave,onConfirm:ee}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${m?"bg-red-500 text-white hover:scale-105 hover:bg-red-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(je,{className:"w-6 h-6"})," ",r.save]})})]},"editor"):e.jsx(N.div,{variants:L,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-red-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:r.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:r.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:r.searchPlaceholder,value:T,onChange:s=>V(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-red-500 transition-colors text-white"}),e.jsx(pe,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),A.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:A.map(s=>e.jsx(Te,{job:s,language:g,onClick:()=>Q(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:r.noJobsFound})})]})},"select")})})}export{Ae as default};
