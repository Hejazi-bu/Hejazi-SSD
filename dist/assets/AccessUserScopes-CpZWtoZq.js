import{u as le,a as ie,b as de,d as me,f as ue,al as ge,r,q as $,w as k,h as u,am as xe,an as J,k as e,A as he,m as R,l as q,ap as fe,H as pe,as as H,aq as be,ar as ve,N as y}from"./index-AlbxRJrk.js";import{u as je}from"./useAccessManager-rkPHho6Y.js";import{S as ye,a as Ne}from"./ScopeList-BVpSby1C.js";import{F as we}from"./FunnelIcon-C_Cz-zVd.js";import"./TrashIcon-DqVoRP7K.js";import"./UserGroupIcon-Q_vkDVVC.js";const g=xe(),Se={ar:{pageTitle:"نظام تفويض الوصول (استثناءات المستخدمين)",pageDesc:"منح مستخدم محدد صلاحية الوصول إلى نطاقات (شركات/إدارات) إضافية غير مدرجة في وظيفته.",selectUserTitle:"اختر المستخدم",searchPlaceholder:"ابحث عن مستخدم...",noUsersFound:"لا يوجد مستخدمين متاحين في نطاق تحكمك.",save:"حفظ الاستثناءات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث نطاق وصول المستخدم.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ القواعد؟",changeUser:"تغيير المستخدم",loadingData:"جاري تحميل البيانات...",currentRules:"قواعد الاستثناء الحالية",conflictTitle:"تحديث خارجي",conflictMessage:"تم تعديل البيانات من مصدر آخر. هل تريد تحميل الجديد؟",loadNew:"تحميل الجديد",ignore:"تجاهل"},en:{pageTitle:"Access Delegation (User Exceptions)",pageDesc:"Grant a specific user access to scopes (Companies/Departments) beyond their job definition.",selectUserTitle:"Select User",searchPlaceholder:"Search user...",noUsersFound:"No users found in your control scope.",save:"Save Exceptions",saving:"Saving...",successTitle:"Success",successMessage:"User access scope updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save rules?",changeUser:"Change User",loadingData:"Loading data...",currentRules:"Current Exception Rules",conflictTitle:"External Update",conflictMessage:"Data updated externally. Load new data?",loadNew:"Load New",ignore:"Ignore"}},Ue=({user:n,onClick:s,language:x})=>e.jsx(R.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:s,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors overflow-hidden border border-gray-600",children:n.avatar_url?e.jsx("img",{src:n.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(H,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-100",children:x==="ar"?n.name_ar:n.name_en}),e.jsx("p",{className:"text-xs text-gray-500",children:x==="ar"?n.job?.name_ar:n.job?.name_en}),e.jsx("p",{className:"text-[10px] text-gray-600 mt-1",children:x==="ar"?n.company?.name_ar:n.company?.name_en})]})]})});function Ae(){const{language:n}=le(),s=Se[n],{canManageScope:x}=ie(),{updateUserAccessScope:_}=je(),{showDialog:p}=de(),{showActionLoading:B,hideActionLoading:G}=me(),{setIsDirty:b}=ue(),[Re,D]=ge(),[V,W]=r.useState([]),[T,z]=r.useState([]),[C,K]=r.useState([]),[I,Q]=r.useState([]),[E,X]=r.useState([]),[A,Y]=r.useState([]),[d,M]=r.useState(null),[N,Z]=r.useState(null),[S,ee]=r.useState(""),[v,P]=r.useState([]),[j,w]=r.useState([]),[se,U]=r.useState(!0);r.useEffect(()=>{(async()=>{U(!0);try{const o=J(u(g,"users"),t=>{const oe=t.docs.map(f=>({id:f.id,...f.data()})).filter(f=>x("control",{userId:f.id,companyId:f.company_id,jobId:String(f.job_id)}));W(oe)}),[m,l,c,h,O]=await Promise.all([y(u(g,"jobs")),y($(u(g,"companies"),k("is_allowed","==",!0))),y(u(g,"sectors")),y(u(g,"departments")),y(u(g,"sections"))]);return z(m.docs.map(t=>({id:t.id,...t.data()}))),K(l.docs.map(t=>({id:t.id,...t.data()}))),Q(c.docs.map(t=>({id:t.id,...t.data()}))),X(h.docs.map(t=>({id:t.id,...t.data()}))),Y(O.docs.map(t=>({id:t.id,...t.data()}))),U(!1),()=>o()}catch(o){console.error("Error fetching data:",o),U(!1)}})()},[x]);const i=r.useMemo(()=>JSON.stringify(j)!==JSON.stringify(v),[j,v]);r.useEffect(()=>b(i),[i,b]);const F=r.useRef(i);r.useEffect(()=>{F.current=i},[i]),r.useEffect(()=>{if(!d)return;const a=$(u(g,"access_user_scopes"),k("user_id","==",d)),o=J(a,m=>{if(m.metadata.hasPendingWrites)return;const l=m.docs.map(c=>({docId:c.id,...c.data()}));if(F.current){const c=JSON.stringify(l),h=JSON.stringify(v);c!==h&&p({variant:"alert",title:s.conflictTitle,message:s.conflictMessage,confirmText:s.loadNew,cancelText:s.ignore,onConfirm:()=>{P(l),w(l)}})}else P(l),w(l),b(!1)});return()=>o()},[d,b,s,v,p]);const ae=a=>{M(a.id),Z(a),D({userId:a.id})},te=a=>{w(o=>[...o,{...a,isNew:!0}])},re=a=>{w(o=>o.filter((m,l)=>l!==a))},ce=async()=>{if(!(!d||!i)){B(s.saving);try{const a=v.filter(c=>!j.some(h=>h.docId===c.docId)),o=j.filter(c=>!c.docId),m=a.map(c=>_(d,{},"remove",c.docId)),l=o.map(c=>{const{isNew:h,docId:O,...t}=c;return _(d,t,"add")});await Promise.all([...m,...l]),p({variant:"success",title:s.successTitle,message:s.successMessage})}catch(a){p({variant:"alert",title:s.errorTitle,message:a.message||s.errorMessage})}finally{G()}}},L=V.filter(a=>a.name_ar?.includes(S)||a.name_en?.includes(S));return se?e.jsx("div",{className:"flex items-center justify-center min-h-screen text-gray-400",children:s.loadingData}):e.jsx("div",{className:"w-full flex flex-col min-h-screen",children:e.jsx(he,{mode:"wait",children:d?e.jsxs(R.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 mb-6 flex justify-between items-center shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)] overflow-hidden",children:N?.avatar_url?e.jsx("img",{src:N.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx(H,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:n==="ar"?N?.name_ar:N?.name_en}),e.jsx("p",{className:"text-xs text-blue-400 font-medium",children:s.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{M(null),b(!1),D({})},className:"text-sm text-gray-400 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-lg transition-all flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"})," ",s.changeUser]})]}),e.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6",children:e.jsxs("div",{className:"xl:col-span-3 space-y-6",children:[e.jsx(ye,{jobs:T,companies:C,sectors:I,departments:E,sections:A,onAddRule:te,t:s}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"h-px bg-gray-700 flex-1"}),e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1",children:[e.jsx(we,{className:"w-3 h-3"})," ",s.currentRules]}),e.jsx("div",{className:"h-px bg-gray-700 flex-1"})]}),e.jsx(Ne,{rules:j,onRemove:re,jobs:T,companies:C,sectors:I,departments:E,sections:A,t:s})]})}),e.jsx("div",{className:"flex justify-center pb-10 mt-12",children:e.jsxs("button",{disabled:!i,onClick:()=>p({variant:"confirm",title:s.confirmSave,message:s.confirmSave,onConfirm:ce}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${i?"bg-blue-500 text-white hover:scale-105 hover:bg-blue-600":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(ve,{className:"w-6 h-6"})," ",s.save]})})]},"editor"):e.jsx(R.div,{variants:q,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-blue-400",children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.pageTitle}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.pageDesc})]})]}),e.jsx("div",{className:"my-6 border-t border-gray-700/50"}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:s.searchPlaceholder,value:S,onChange:a=>ee(a.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(pe,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),L.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:L.map(a=>e.jsx(Ue,{user:a,language:n,onClick:()=>ae(a)},a.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500 border-2 border-dashed border-gray-700 rounded-xl",children:e.jsx("p",{children:s.noUsersFound})})]})},"select")})})}export{Ae as default};
