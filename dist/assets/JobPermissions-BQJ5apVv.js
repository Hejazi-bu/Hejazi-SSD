import{u as he,a as xe,b as fe,d as ve,f as ye,al as Se,r,q as $,w as k,h as S,am as je,an as we,k as e,A as _e,m as F,l as Y,ao as Ne,H as Je,v as Z,ap as Ce,s as Te,J as ee,aq as Pe,ar as Me,N as w,as as Ee}from"./index-DjQnKye2.js";import{u as Re}from"./useAccessManager-ByKSRh3L.js";import{S as $e}from"./DelegationTree-BM3T4QwY.js";import{F as ke}from"./AdjustmentsHorizontalIcon-C5lpyWEE.js";import"./ChevronDownIcon-qIRIwReu.js";import"./ChevronRightIcon-B_NjU3cg.js";import"./CogIcon-CQGT2rf7.js";import"./PencilIcon-u-NC4gBe.js";const j=je(),Fe={ar:{pageTitle:"إدارة صلاحيات الوظائف",selectJobTitle:"اختيار الوظيفة",searchPlaceholder:"ابحث عن وظيفة...",filterTreePlaceholder:"بحث داخل الخدمات...",noJobsFound:"لم يتم العثور على وظائف.",save:"حفظ الصلاحيات",saving:"جاري الحفظ...",successTitle:"تم بنجاح",successMessage:"تم تحديث صلاحيات الوظيفة.",errorTitle:"خطأ",errorMessage:"حدث خطأ أثناء الحفظ.",confirmSave:"هل أنت متأكد من حفظ التغييرات؟",changeJob:"تغيير الوظيفة",levelService:"خدمة",levelPage:"صفحة",levelAction:"إجراء",scopeGlobal:"عام (الكل)",scopeRestricted:"مقيد بنطاق محدد",configureScope:"تخصيص النطاق",conflictTitle:"تحديث خارجي",conflictMessage:"بيانات خارجية تغيرت. هل تريد التحديث؟",loadNew:"تحميل",ignore:"تجاهل",cancel:"إلغاء",companyLabel:"الشركة",sectionLabel:"القسم",distributionNotice:"تظهر هنا فقط الشركات والأقسام التي تم توزيع هذه الوظيفة عليها."},en:{pageTitle:"Manage Job Permissions",selectJobTitle:"Select Job",searchPlaceholder:"Search job...",filterTreePlaceholder:"Search services...",noJobsFound:"No jobs found.",save:"Save Permissions",saving:"Saving...",successTitle:"Success",successMessage:"Job permissions updated.",errorTitle:"Error",errorMessage:"Error saving changes.",confirmSave:"Save changes?",changeJob:"Change Job",levelService:"Service",levelPage:"Page",levelAction:"Action",scopeGlobal:"Global (All)",scopeRestricted:"Restricted Scope",configureScope:"Configure Scope",conflictTitle:"External Update",conflictMessage:"External data changed. Update?",loadNew:"Load",ignore:"Ignore",cancel:"Cancel",companyLabel:"Company",sectionLabel:"Section",distributionNotice:"Only companies/sections where this job is distributed appear here."}},Ie=({isOpen:m,onClose:o,onSave:_,validCompanies:N,validSections:I,initialScope:x,t:h,language:P})=>{const[v,A]=r.useState(x?.scope_company_id||""),[J,M]=r.useState(x?.scope_section_id||"");return r.useEffect(()=>{m&&(A(x?.scope_company_id||""),M(x?.scope_section_id||""))},[m,x]),m?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-gray-800 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl animate-in fade-in zoom-in duration-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-bold text-white flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5 text-blue-400"}),h.configureScope]}),e.jsx("button",{onClick:o,children:e.jsx(Ee,{className:"w-5 h-5 text-gray-500 hover:text-white"})})]}),e.jsx("p",{className:"text-xs text-yellow-500/80 mb-4 bg-yellow-500/10 p-2 rounded border border-yellow-500/20",children:h.distributionNotice}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:h.companyLabel}),e.jsxs("select",{value:v,onChange:l=>A(l.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none",children:[e.jsx("option",{value:"",children:h.scopeGlobal}),N.map(l=>e.jsx("option",{value:l.id,children:P==="ar"?l.name_ar:l.name_en},l.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:h.sectionLabel}),e.jsxs("select",{value:J,onChange:l=>M(l.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none",children:[e.jsx("option",{value:"",children:h.scopeGlobal}),I.map(l=>e.jsx("option",{value:l.id,children:P==="ar"?l.name_ar:l.name_en},l.id))]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6 border-t border-gray-700 pt-4",children:[e.jsx("button",{onClick:o,className:"text-gray-400 hover:text-white text-sm font-medium px-3 py-2",children:h.cancel}),e.jsx("button",{onClick:()=>_({scope_company_id:v||null,scope_section_id:J||null}),className:"bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/20",children:h.save})]})]})}):null},Ae=({job:m,onClick:o,language:_})=>e.jsx(F.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:o,className:"bg-gray-800/50 border border-gray-700 hover:border-blue-500/50 rounded-xl p-4 cursor-pointer transition-all group",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-400 transition-colors border border-gray-600",children:e.jsx(Z,{className:"w-6 h-6"})}),e.jsx("div",{children:e.jsx("h3",{className:"font-bold text-gray-100",children:_==="ar"?m.name_ar:m.name_en})})]})});function Qe(){const{language:m}=he(),o=Fe[m],{canManageScope:_,canGrantResource:N}=xe(),{updateJobPermissions:I}=Re(),{showDialog:x}=fe(),{showActionLoading:h,hideActionLoading:P}=ve(),{setIsDirty:v}=ye(),[A,J]=Se(),[M,l]=r.useState([]),[U,se]=r.useState([]),[ae,D]=r.useState([]),[te,L]=r.useState([]),[f,H]=r.useState(null),[Q,ie]=r.useState(null),[O,re]=r.useState(""),[E,W]=r.useState(""),[b,C]=r.useState(new Map),[T,z]=r.useState(new Map),[oe,G]=r.useState(!1),[R,B]=r.useState(null);r.useEffect(()=>{(async()=>{try{const[n,a,t,d]=await Promise.all([w(S(j,"jobs")),w(S(j,"services")),w(S(j,"sub_services")),w(S(j,"sub_sub_services"))]),c=n.docs.map(i=>({id:i.id,...i.data()}));l(c.filter(i=>_("access",{jobId:i.id})));const u=m==="ar"?"label_ar":"label_en",p=a.docs.map(i=>({...i.data(),id:i.data().id??i.id})),q=t.docs.map(i=>({...i.data(),id:i.data().id??i.id})),pe=d.docs.map(i=>({...i.data(),id:i.data().id??i.id})),be=p.map(i=>{const V=q.filter(g=>String(g.service_id)===String(i.id)).map(g=>({id:`ss:${g.id}`,label:g[u],parentId:`s:${i.id}`,type:"page",children:[]})),ge=pe.filter(g=>String(g.service_id)===String(i.id)).map(g=>({id:`sss:${g.id}`,label:g[u],parentId:`s:${i.id}`,type:"action",children:[]}));return{id:`s:${i.id}`,label:i[u],type:"service",children:[...V,...ge].sort((g,De)=>g.type==="page"?-1:1)}}).sort((i,V)=>i.id.toString().localeCompare(V.id.toString(),void 0,{numeric:!0}));se(be)}catch(n){console.error(n)}})()},[m,_]),r.useEffect(()=>{if(!f){D([]),L([]);return}(async()=>{try{const n=$(S(j,"job_distribution"),k("job_id","==",String(f))),a=await w(n),t=new Set,d=new Set;if(a.forEach(c=>{const u=c.data();u.company_id&&t.add(u.company_id),u.section_id&&d.add(u.section_id)}),t.size>0){const u=(await w($(S(j,"companies"),k("is_allowed","==",!0)))).docs.map(p=>({id:p.id,...p.data()})).filter(p=>t.has(p.id));D(u)}else D([]);if(d.size>0){const u=(await w($(S(j,"sections"),k("is_active","==",!0)))).docs.map(p=>({id:p.id,...p.data()})).filter(p=>d.has(p.id));L(u)}else L([])}catch(n){console.error("Error fetching job distribution:",n)}})()},[f]);const y=r.useMemo(()=>{if(b.size!==T.size)return!0;for(const[s,n]of b){const a=T.get(s);if(!a||JSON.stringify(n)!==JSON.stringify(a))return!0}return!1},[b,T]);r.useEffect(()=>v(y),[y,v]);const K=r.useRef(y);r.useEffect(()=>{K.current=y},[y]),r.useEffect(()=>{if(!f)return;const s=$(S(j,"job_permissions"),k("job_id","==",String(f))),n=we(s,a=>{if(a.metadata.hasPendingWrites)return;const t=new Map;a.forEach(d=>{const c=d.data(),u=c.sub_sub_service_id?`sss:${c.sub_sub_service_id}`:c.sub_service_id?`ss:${c.sub_service_id}`:`s:${c.service_id}`,p=c.scope_companies&&c.scope_companies.length>0?c.scope_companies[0]:c.scope_company_id||null,q=c.scope_sections&&c.scope_sections.length>0?c.scope_sections[0]:c.scope_section_id||null;t.set(u,{scope_company_id:p,scope_section_id:q})}),K.current?(C(t),z(new Map(t))):(C(t),z(new Map(t)))});return()=>n()},[f]);const ne=s=>{H(s.id),ie(s),W(""),v(!1),J({jobId:s.id})},ce=r.useCallback(s=>b.has(s),[b]),le=r.useCallback((s,n)=>{C(n===!0?a=>new Map(a).set(s,{scope_company_id:null,scope_section_id:null}):a=>{const t=new Map(a);return t.delete(s),t})},[]),de=s=>{R&&(C(n=>new Map(n).set(R,s)),G(!1),B(null))},ue=async()=>{if(!f||!y)return;const s=[],n=[];b.forEach((a,t)=>{const d=T.get(t);if(!d||JSON.stringify(d)!==JSON.stringify(a)){const c={companies:a.scope_company_id?[a.scope_company_id]:[],sections:a.scope_section_id?[a.scope_section_id]:[],departments:[]};s.push({id:t,is_allowed:!0,scope:c})}}),T.forEach((a,t)=>{b.has(t)||n.push(t)}),h(o.saving);try{await I(f,s,n),z(new Map(b)),v(!1),x({variant:"success",title:o.successTitle,message:o.successMessage})}catch(a){x({variant:"alert",title:o.errorTitle,message:a.message||o.errorMessage})}finally{P()}},X=M.filter(s=>s.name_ar?.includes(O)||s.name_en?.includes(O)),me=r.useMemo(()=>{const s=n=>n.reduce((a,t)=>{if(!N(t.id))return a;const d=s(t.children);return(t.label.toLowerCase().includes(E.toLowerCase())||d.length>0)&&a.push({...t,children:d}),a},[]);return s(U)},[U,E,N]);return e.jsxs("div",{className:"w-full flex flex-col min-h-screen",children:[e.jsx(Ie,{isOpen:oe,onClose:()=>G(!1),onSave:de,validCompanies:ae,validSections:te,initialScope:R?b.get(R):null,t:o,language:m}),e.jsx(_e,{mode:"wait",children:f?e.jsxs(F.div,{variants:Y,initial:"initial",animate:"animate",exit:"exit",className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-4 space-y-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center border-2 border-blue-500",children:e.jsx(Z,{className:"w-6 h-6 text-gray-100"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:m==="ar"?Q?.name_ar:Q?.name_en}),e.jsx("p",{className:"text-xs text-gray-400",children:o.pageTitle})]})]}),e.jsxs("button",{onClick:()=>{H(null),v(!1),J({})},className:"text-sm text-blue-400 hover:underline flex items-center gap-1",children:[e.jsx(Ce,{className:"w-4 h-4"})," ",o.changeJob]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:o.filterTreePlaceholder,value:E,onChange:s=>W(s.target.value),className:"w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-4 pl-10 focus:border-blue-500 text-sm text-white"}),e.jsx(ke,{className:"w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]})]}),e.jsx("div",{className:"bg-gray-900/30 border border-gray-700 rounded-xl p-2 mb-8",children:e.jsx(F.div,{variants:Te,initial:"initial",animate:"animate",children:me.map(s=>{const n=b.has(s.id),a=b.get(s.id),t=a?.scope_company_id||a?.scope_section_id;return e.jsx($e,{node:s,getState:ce,onToggle:le,canEdit:N,t:o,searchTerm:E,rowType:"job",children:n&&e.jsx("button",{onClick:d=>{d.stopPropagation(),B(s.id),G(!0)},className:`p-1.5 rounded-md hover:bg-gray-700 transition-colors ${t?"text-orange-400 bg-orange-500/10":"text-gray-600"}`,title:o.configureScope,children:t?e.jsx(ee,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"})})},s.id)})})}),e.jsx("div",{className:"flex justify-center pb-10 mt-auto",children:e.jsxs("button",{disabled:!y,onClick:()=>x({variant:"confirm",title:o.confirmSave,message:o.confirmSave,onConfirm:ue}),className:`w-full max-w-md font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all ${y?"bg-[#FFD700] text-black hover:scale-105":"bg-gray-700 text-gray-500 cursor-not-allowed opacity-50"}`,children:[e.jsx(Me,{className:"w-6 h-6"})," ",o.save]})})]},"editor"):e.jsx(F.div,{variants:Y,initial:"initial",animate:"animate",exit:"exit",className:"space-y-6",children:e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 text-blue-400",children:[e.jsx(Ne,{className:"w-6 h-6"}),e.jsx("h2",{className:"text-xl font-bold",children:o.selectJobTitle})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("input",{type:"text",placeholder:o.searchPlaceholder,value:O,onChange:s=>re(s.target.value),className:"w-full bg-gray-900/50 border border-gray-600 rounded-lg py-3 px-4 pl-10 focus:border-blue-500 transition-colors text-white"}),e.jsx(Je,{className:"w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"})]}),X.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:X.map(s=>e.jsx(Ae,{job:s,language:m,onClick:()=>ne(s)},s.id))}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:e.jsx("p",{children:o.noJobsFound})})]})},"select")})]})}export{Qe as default};
