import{a as Z,b as H,c as ee,d as se,e as ae,f as te,r as p,j as T,k as e,A as re,m as _,l as ne,s as ie,aJ as oe,aq as le,at as ce,x as P,aK as O,n as de,D as ue,E as ge}from"./index-DjQnKye2.js";import{u as me,a as be,b as fe,c as xe,M as E,F as pe}from"./AhmedSaeedShared-CxRPbuOS.js";import{F as ve}from"./Squares2X2Icon-CvsrrMi5.js";import{F as he}from"./PencilIcon-u-NC4gBe.js";import{F as ye}from"./TrashIcon-CBwyCsvA.js";import{F as _e}from"./PlusIcon-VqZkTY5V.js";import"./ChevronDownIcon-qIRIwReu.js";const A=({label:i,Icon:l,children:o,error:u})=>e.jsxs(_.div,{variants:P,className:`bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 shadow-md border ${u?"border-red-500":"border-gray-700"} transition-colors duration-300`,children:[e.jsxs("label",{className:"flex items-center gap-2 mb-1 font-semibold text-gray-300 text-sm",children:[e.jsx(l,{className:"w-5 h-5 text-[#FFD700]"}),i]}),o]});function we({label:i,subTasks:l,onChange:o,error:u,placeholder:w}){const[h,j]=p.useState(""),k=()=>{const n=T(h);if(!n)return;const c={text:n,is_done:!1};o([...l,c]),j("")},y=(n,c)=>{const m=T(c),f=l.map((t,r)=>r===n?{...t,text:m}:t);o(f)},F=n=>{const c=l.filter((m,f)=>f!==n);o(c)};return e.jsxs(_.div,{variants:P,className:`bg-gradient-to-br from-gray-900/60 to-gray-800/60 rounded-lg p-3 shadow-md border ${u?"border-red-500":"border-gray-700"} transition-colors duration-300`,children:[e.jsxs("label",{className:"flex items-center gap-2 mb-2 font-semibold text-gray-300 text-sm",children:[e.jsx(pe,{className:"w-5 h-5 text-[#FFD700]"}),i]}),e.jsxs("div",{className:"space-y-2 mb-3",children:[l.map((n,c)=>e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("textarea",{value:n.text,onChange:m=>y(c,m.target.value),rows:2,className:"flex-grow w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700] text-sm text-gray-200"}),e.jsx("button",{type:"button",onClick:()=>F(c),className:"flex-shrink-0 p-2.5 text-gray-400 hover:text-red-400 transition-colors",title:"حذف المهمة",children:e.jsx(ye,{className:"w-5 h-5"})})]},c)),l.length===0&&e.jsx("p",{className:"text-sm text-gray-500 text-center p-2",children:"لم تتم إضافة أي مهام فرعية."})]}),e.jsxs("div",{className:"flex items-start gap-2 pt-3 border-t border-gray-700",children:[e.jsx("textarea",{placeholder:w,value:h,onChange:n=>j(n.target.value),rows:3,className:"flex-grow w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700] text-sm text-gray-200"}),e.jsx("button",{type:"button",onClick:k,className:"flex-shrink-0 bg-[#FFD700] text-black px-4 py-2.5 rounded-lg font-bold disabled:bg-gray-600 disabled:text-gray-400",disabled:!h.trim(),children:e.jsx(_e,{className:"w-5 h-5"})})]})]})}function je({formData:i,formErrors:l,onFieldChange:o,onMultiSelectChange:u,onSubTasksChange:w,allCountries:h,allServices:j,allUniversities:k,allPersons:y,onSubmit:F,isSubmitting:n,translations:c,dialogHook:m,actionLoadingHook:f}){const t=c.ar;return e.jsxs(_.div,{variants:ie,initial:"initial",animate:"animate",exit:"exit",className:"flex-grow bg-gray-800/50 rounded-xl shadow-2xl space-y-6 p-4 sm:p-6 border border-gray-700",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(E,{label:t.services,Icon:ve,options:j,selectedValues:i.services,onChange:r=>u("services",r),error:l.services,collectionName:"app_services",readOnly:!1,nameField:"name",dialogHook:m,actionLoadingHook:f,enableOrdering:!0}),e.jsx(E,{label:t.universities,Icon:oe,options:k,selectedValues:i.universities,onChange:r=>u("universities",r),error:!1,collectionName:"app_universities",readOnly:!1,nameField:"name",dialogHook:m,actionLoadingHook:f,enableOrdering:!0}),e.jsx(E,{label:t.countries,Icon:le,options:h,selectedValues:i.countries,onChange:r=>u("countries",r),error:!1,collectionName:"app_countries",readOnly:!1,nameField:"name_ar",dialogHook:m,actionLoadingHook:f,enableOrdering:!0}),e.jsx(E,{label:t.responsiblePerson,Icon:ce,options:y,selectedValues:i.responsiblePersons,onChange:r=>u("responsiblePersons",r),error:!1,collectionName:"app_responsible_persons",readOnly:!1,nameField:"name",dialogHook:m,actionLoadingHook:f,enableOrdering:!0})]}),e.jsxs(_.div,{variants:P,className:"space-y-6 pt-4 border-t border-gray-700",children:[e.jsx(A,{label:t.taskTitle,Icon:he,error:l.title,children:e.jsx("input",{type:"text",placeholder:t.taskTitlePlaceholder,value:i.title,onChange:r=>o("title",r.target.value),className:"w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700]"})}),e.jsx(we,{label:t.taskSubTasks,subTasks:i.sub_tasks,onChange:w,error:l.sub_tasks,placeholder:t.taskSubTasksPlaceholder}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(A,{label:t.startDate,Icon:O,children:e.jsx("input",{type:"datetime-local",value:i.start_at,onChange:r=>o("start_at",r.target.value),className:"w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700] [color-scheme:dark]"})}),e.jsx(A,{label:t.endDate,Icon:O,children:e.jsx("input",{type:"datetime-local",value:i.end_at,onChange:r=>o("end_at",r.target.value),className:"w-full bg-gray-700 p-2.5 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#FFD700] [color-scheme:dark]"})})]})]}),e.jsx(_.div,{variants:P,children:e.jsxs("div",{className:"bg-gray-900/50 border border-yellow-400/50 rounded-lg p-6 mt-4",children:[e.jsx("h2",{className:"text-xl font-bold text-[#FFD700] mb-4 text-center",children:t.confirmAction}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"relative mt-4 flex flex-col items-center",children:e.jsx(_.button,{onClick:F,className:"bg-[#FFD700] text-black px-8 py-3 rounded-lg font-bold disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors",disabled:n,variants:de,whileHover:"hover",whileTap:"tap",children:n?t.saving:t.save})})})]})})]})}function Pe(){const{user:i,isLoading:l}=Z(),{showDialog:o}=H(),{setPageLoading:u}=ee(),{showActionLoading:w,hideActionLoading:h}=se(),j=ae(),{isDirty:k,setIsDirty:y}=te(),{allCountries:F,countriesLoading:n}=me(),{allServices:c,servicesLoading:m}=be(),{allUniversities:f,universitiesLoading:t}=fe(),{allPersons:r,personsLoading:I}=xe(),L={services:[],universities:[],countries:[],responsiblePersons:[],title:"",sub_tasks:[],start_at:"",end_at:""},M={services:!1,title:!1,sub_tasks:!1},[s,S]=p.useState(L),[C,N]=p.useState(M),[V,R]=p.useState(!1),[D,U]=p.useState(!1),$=p.useMemo(()=>{const a={pageTitle:"مهمة جديدة (أحمد سعيد)",services:"الخدمات",universities:"الجامعات",countries:"الدول",responsiblePerson:"الأشخاص المسؤولون",taskTitle:"عنوان المهمة (إجباري)",taskTitlePlaceholder:"أدخل عنوان المهمة...",taskSubTasks:"المهام الفرعية / الوصف (إجباري)",taskSubTasksPlaceholder:"اكتب وصف المهمة الفرعية هنا...",confirmAction:"تأكيد الإجراء",startDate:"تاريخ ووقت البدء (اختياري)",endDate:"تاريخ ووقت الانتهاء (اختياري)",noSignatureTitle:"التوقيع مطلوب",noSignatureMessage:"يجب عليك رفع توقيعك في ملفك الشخصي أولاً قبل إنشاء مهمة جديدة.",confirmSaveTitle:"تأكيد الحفظ",confirmSaveMessage:"هل أنت متأكد من حفظ هذه المهمة؟",validationErrorTitle:"بيانات غير مكتملة",validationErrorMessage:"يرجى ملء جميع الحقول الإلزامية (الخدمات، العنوان، ومهمة فرعية واحدة على الأقل).",successTitle:"نجاح",successMessage:"تم حفظ المهمة بنجاح.",errorTitle:"خطأ",genericErrorMessage:"حدث خطأ أثناء حفظ المهمة.",saving:"جاري الحفظ...",save:"حفظ المهمة"};return{ar:a,en:a}},[]),v=$.ar,B=(a,b)=>{S(d=>({...d,[a]:b})),a in C&&N(d=>({...d,[a]:!1}))},q=(a,b)=>{S(d=>({...d,[a]:b})),a in C&&N(d=>({...d,[a]:!1}))},J=a=>{S(b=>({...b,sub_tasks:a})),C.sub_tasks&&a.length>0&&N(b=>({...b,sub_tasks:!1}))};p.useEffect(()=>{const a=T(s.title).length>0||s.sub_tasks.length>0||s.services.length>0||s.universities.length>0||s.countries.length>0||s.responsiblePersons.length>0||!!(s.start_at&&s.start_at.length>0)||!!(s.end_at&&s.end_at.length>0);return y(a),()=>{y(!1)}},[s,y]),p.useEffect(()=>{const a=b=>{k&&(b.preventDefault(),b.returnValue="")};return window.addEventListener("beforeunload",a),()=>{window.removeEventListener("beforeunload",a)}},[k]),p.useEffect(()=>{!l&&!n&&!m&&!t&&!I&&!D&&(U(!0),u(!1))},[l,n,m,t,I,D,u]);const K=async()=>{const a={services:s.services.length===0,title:!T(s.title),sub_tasks:s.sub_tasks.length===0};if(N(a),Object.values(a).some(Boolean)){o({variant:"alert",title:v.validationErrorTitle,message:v.validationErrorMessage});return}const b=async()=>{R(!0),y(!1),w(v.saving);try{if(!i)throw new Error("User data is not available.");const d=g=>g.reduce((x,Y)=>(x[Y]=!0,x),{}),z=s.countries.map(g=>F?.find(x=>x.id===g)?.name_ar||g),G=s.responsiblePersons.map(g=>r?.find(x=>x.id===g)?.name||g),Q=s.universities.map(g=>f?.find(x=>x.id===g)?.name||g),W=s.services.map(g=>c?.find(x=>x.id===g)?.name||g),X={title:T(s.title),sub_tasks:s.sub_tasks,creator_id:i.id,services_map:d(s.services),universities_map:d(s.universities),countries_map:d(s.countries),responsible_persons_map:d(s.responsiblePersons),services_list:W,universities_list:Q,countries_list:z,responsible_persons_list:G,start_at:s.start_at||null,end_at:s.end_at||null};await ue(ge,"createNewTask")({taskData:X}),S(L),N(M),o({variant:"success",title:v.successTitle,message:v.successMessage,onConfirm:()=>{j("/tasks")}})}catch(d){o({variant:"alert",title:v.errorTitle,message:d.message||v.genericErrorMessage})}finally{h(),R(!1)}};o({variant:"confirm",title:v.confirmSaveTitle,message:v.confirmSaveMessage,onConfirm:b})};return p.useEffect(()=>{u(!D)},[D,u]),e.jsx(re,{mode:"wait",children:e.jsx(_.div,{dir:"rtl",variants:ne,initial:"initial",animate:"animate",exit:"exit",children:e.jsx(je,{formData:s,formErrors:C,onFieldChange:B,onMultiSelectChange:q,onSubTasksChange:J,allCountries:F,allServices:c,allUniversities:f,allPersons:r,onSubmit:K,isSubmitting:V,translations:$,dialogHook:{showDialog:o},actionLoadingHook:{showActionLoading:w,hideActionLoading:h}})})})}export{Pe as default};
